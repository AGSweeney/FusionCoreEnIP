/*
 * Copyright (c) 2025, Adam G. Sweeney <agsweeney@gmail.com>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

#include "webui_api.h"
#include <string.h>
#include <stdbool.h>
#include <stdlib.h>

const char *webui_get_index_html(void)
{
    return "<!DOCTYPE html>"
           "<html lang=\"en\">"
           "<head>"
           "<meta charset=\"UTF-8\">"
           "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">"
           "<title>Device Configuration</title>"
           "<style>"
           "* { box-sizing: border-box; }"
           "html { overflow-y: scroll; }"
           "body { padding: 0; margin: 0; background-color: #f5f5f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; scrollbar-gutter: stable; }"
           ".navbar { background-color: #212529; padding: 15px 0; margin-bottom: 20px; }"
           ".navbar-nav { display: flex; flex-direction: row; flex-wrap: wrap; list-style: none; margin: 0; padding: 0 20px; justify-content: center; align-items: center; width: 100%; gap: 15px; }"
           ".navbar-nav li { margin: 0; }"
           "@media (max-width: 768px) { .navbar-nav { gap: 8px; } .navbar-nav a { padding: 6px 12px; font-size: 13px; } }"
           ".navbar-nav a { color: #ffffff; text-decoration: none; font-weight: 500; padding: 8px 16px; border-radius: 4px; transition: background-color 0.2s; white-space: nowrap; display: inline-block; }"
           ".navbar-nav a:hover { background-color: rgba(255, 255, 255, 0.1); }"
           ".navbar-nav a.active { background-color: #007bff; }"
           ".content-wrapper { padding: 20px; }"
           ".container { max-width: 800px; background: white; padding: 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 0 auto; overflow: hidden; }"
           ".page-header { background-color: #f8f9fa; padding: 20px 30px; border-bottom: 1px solid #dee2e6; }"
           ".page-header h1 { margin: 0; color: #212529; font-size: 1.75rem; font-weight: 700; text-transform: uppercase; }"
           ".page-content { padding: 30px; }"
           ".form-group { margin-bottom: 20px; }"
           "label { font-weight: 600; color: #555; display: block; margin-bottom: 5px; }"
           ".form-control { display: block; width: 100%; padding: 8px 12px; font-size: 14px; line-height: 1.5; color: #495057; background-color: #fff; border: 1px solid #ced4da; border-radius: 4px; }"
           ".form-control:focus { border-color: #80bdff; outline: 0; box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25); }"
           ".btn { display: inline-block; padding: 8px 16px; font-size: 14px; font-weight: 400; text-align: center; cursor: pointer; border: 1px solid transparent; border-radius: 4px; text-decoration: none; }"
           ".btn-primary { color: #fff; background-color: #007bff; border-color: #007bff; }"
           ".btn-primary:hover { background-color: #0069d9; border-color: #0062cc; }"
           ".alert { position: relative; padding: 12px 20px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px; }"
           ".alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }"
           ".alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }"
           ".alert-info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb; }"
           ".status-card { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 0; margin-bottom: 20px; background-color: #fff; overflow: hidden; }"
           ".card-header { background-color: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #dee2e6; margin: 0; }"
           ".card-header h2 { margin: 0; color: #212529; font-size: 1.25rem; font-weight: 600; }"
           ".card-body { padding: 20px; }"
           "input[type=\"checkbox\"] { width: 18px; height: 18px; margin-right: 8px; vertical-align: middle; }"
           ".page { display: block; }"
           ".page.hidden { display: none; }"
           ".nav-link.active { background-color: #007bff; }"
           "</style>"
           "</head>"
           "<body>"
           "<nav class=\"navbar\">"
           "<ul class=\"navbar-nav\">"
           "<li><a href=\"/\" class=\"active\">Network</a></li>"
           "<li><a href=\"/vl53l1x\">Distance</a></li>"
           "<li><a href=\"/lsm6ds3\">Gyro</a></li>"
           "<li><a href=\"/nau7802\">Scale</a></li>"
           "<li><a href=\"/gp8403\">DAC</a></li>"
           "<li><a href=\"/mcp230xx\">Outputs</a></li>"
           "<li><a href=\"/i2c\">Pull-ups</a></li>"
           "<li><a href=\"/ota\">Firmware Update</a></li>"
           "</ul>"
           "</nav>"
           "<div class=\"content-wrapper\">"
           "<div class=\"container\">"
           "<div id=\"config-page\" class=\"page\">"
           "<div class=\"page-header\">"
           "<h1>Device Configuration</h1>"
           "</div>"
           "<div class=\"page-content\">"
           "<div id=\"message\" class=\"alert\" style=\"display: none;\"></div>"
           
           "<!-- Network Configuration -->"
           "<div class=\"status-card\">"
           "<div class=\"card-header\">"
           "<h2>Network Configuration</h2>"
           "</div>"
           "<div class=\"card-body\">"
           "<form id=\"ipConfigForm\">"
           "<div class=\"form-group\">"
           "<label>"
           "<input type=\"checkbox\" id=\"use_dhcp\" onchange=\"toggleStaticFields()\">"
           "<span>Use DHCP (Automatic IP Assignment)</span>"
           "</label>"
           "</div>"
           "<div id=\"staticIpFields\" style=\"display: none;\">"
           "<div class=\"form-group\">"
           "<label for=\"ip_address\">IP Address:</label>"
           "<input type=\"text\" id=\"ip_address\" class=\"form-control\" placeholder=\"192.168.1.100\">"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"netmask\">Netmask:</label>"
           "<input type=\"text\" id=\"netmask\" class=\"form-control\" placeholder=\"255.255.255.0\">"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"gateway\">Gateway:</label>"
           "<input type=\"text\" id=\"gateway\" class=\"form-control\" placeholder=\"192.168.1.1\">"
           "</div>"
           "</div>"
           "<div id=\"dnsFields\" style=\"display: none;\">"
           "<div class=\"form-group\">"
           "<label for=\"dns1\">Primary DNS:</label>"
           "<input type=\"text\" id=\"dns1\" class=\"form-control\" placeholder=\"8.8.8.8\">"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"dns2\">Secondary DNS:</label>"
           "<input type=\"text\" id=\"dns2\" class=\"form-control\" placeholder=\"8.8.4.4\">"
           "</div>"
           "</div>"
           "<button type=\"button\" class=\"btn btn-primary\" onclick=\"saveIpConfig()\">Save Network Configuration</button>"
           "</form>"
           "</div>"
           "</div>"
           "</div>"
           "</div>"
           "<footer style=\"text-align: center; padding: 20px 30px; border-top: 1px solid #dee2e6; color: #666; background-color: #f8f9fa;\">FusionCore Ethernet/IP™ Adapter</footer>"
           "</div>"
           "</div>"
           "<script>"
           "function showMessage(text, type) {"
           "  const msg = document.getElementById('message') || document.getElementById('nau7802_message');"
           "  if (msg) {"
           "    msg.textContent = text;"
           "    msg.className = 'alert alert-' + type;"
           "    msg.style.display = 'block';"
           "    setTimeout(function() { msg.style.display = 'none'; }, 5000);"
           "  } else {"
           "    console.log('[' + type.toUpperCase() + '] ' + text);"
           "  }"
           "}"
           "function showPage(pageName) {"
           "  const pages = document.querySelectorAll('.page');"
           "  const navLinks = document.querySelectorAll('.nav-link');"
           "  pages.forEach(p => p.style.display = 'none');"
           "  navLinks.forEach(l => l.classList.remove('active'));"
           "  const targetPage = document.getElementById(pageName + '-page');"
           "  const targetLink = document.querySelector('[data-page=' + pageName + ']');"
           "  if (targetPage) targetPage.style.display = 'block';"
           "  if (targetLink) targetLink.classList.add('active');"
           "  if (pageName === 'nau7802') {"
           "    loadNau7802Config();"
           "    if (!window.nau7802StatusInterval) {"
           "      window.nau7802StatusInterval = setInterval(updateNau7802Status, 200);"
           "    }"
           "  }"
           "}"
           "function loadIpConfig() {"
           "  fetch('/api/ipconfig')"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      const dhcpCheckbox = document.getElementById('use_dhcp');"
           "      const staticFields = document.getElementById('staticIpFields');"
           "      const dnsFields = document.getElementById('dnsFields');"
           "      if (dhcpCheckbox && data.use_dhcp !== undefined) {"
           "        dhcpCheckbox.checked = data.use_dhcp;"
           "        toggleStaticFields();"
           "      }"
           "      const ipAddr = document.getElementById('ip_address');"
           "      const netmask = document.getElementById('netmask');"
           "      const gateway = document.getElementById('gateway');"
           "      const dns1 = document.getElementById('dns1');"
           "      const dns2 = document.getElementById('dns2');"
           "      if (ipAddr) ipAddr.value = (data.ip_address && data.ip_address !== '0.0.0.0') ? data.ip_address : '';"
           "      if (netmask) netmask.value = (data.netmask && data.netmask !== '0.0.0.0') ? data.netmask : '';"
           "      if (gateway) gateway.value = (data.gateway && data.gateway !== '0.0.0.0') ? data.gateway : '';"
           "      if (dns1) dns1.value = (data.dns1 && data.dns1 !== '0.0.0.0') ? data.dns1 : '';"
           "      if (dns2) dns2.value = (data.dns2 && data.dns2 !== '0.0.0.0') ? data.dns2 : '';"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to load IP configuration:', err);"
           "    });"
           "}"
           "function toggleStaticFields() {"
           "  const dhcpCheckbox = document.getElementById('use_dhcp');"
           "  const staticFields = document.getElementById('staticIpFields');"
           "  const dnsFields = document.getElementById('dnsFields');"
           "  if (dhcpCheckbox && staticFields && dnsFields) {"
           "    const useDhcp = dhcpCheckbox.checked;"
           "    staticFields.style.display = useDhcp ? 'none' : 'block';"
           "    dnsFields.style.display = useDhcp ? 'none' : 'block';"
           "  }"
           "}"
           "function saveIpConfig() {"
           "  const data = {"
           "    use_dhcp: document.getElementById('use_dhcp').checked,"
           "    ip_address: document.getElementById('ip_address').value,"
           "    netmask: document.getElementById('netmask').value,"
           "    gateway: document.getElementById('gateway').value,"
           "    dns1: document.getElementById('dns1').value,"
           "    dns2: document.getElementById('dns2').value"
           "  };"
           "  fetch('/api/ipconfig', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify(data)"
           "  })"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      if (data.status === 'ok') {"
           "        showMessage(data.message, 'success');"
           "      } else {"
           "        showMessage('Failed to save IP configuration', 'danger');"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to save IP configuration:', err);"
           "      showMessage('Failed to save IP configuration', 'danger');"
           "    });"
           "}"
           "window.onload = function() {"
           "  loadIpConfig();"
           "};"
           "</script>"
           "</body>"
           "</html>";
}

const char *webui_get_status_html(void)
{
    return "";  // Status page removed
}

const char *webui_get_ethernetip_html(void)
{
    return "";  // Output assembly page removed
}

const char *webui_get_input_assembly_html(void)
{
    return "";  // Input assembly page removed
}

const char *webui_get_mcpconfig_html(void)
{
    return "";  // MCP230x removed from project
}

const char *webui_get_vl53l1xconfig_html(void)
{
    return "";  // VL53L1x removed from project
}

const char *webui_get_mpu6050_html(void)
{
    return "";  // Removed - use API instead
}

const char *webui_get_ota_html(void)
{
    return "<!DOCTYPE html>"
           "<html lang=\"en\">"
           "<head>"
           "<meta charset=\"UTF-8\">"
           "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">"
           "<title>Firmware Update</title>"
           "<style>"
           "* { box-sizing: border-box; }"
           "html { overflow-y: scroll; }"
           "body { padding: 0; margin: 0; background-color: #f5f5f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; scrollbar-gutter: stable; }"
           ".navbar { background-color: #212529; padding: 15px 0; margin-bottom: 20px; }"
           ".navbar-nav { display: flex; flex-direction: row; flex-wrap: wrap; list-style: none; margin: 0; padding: 0 20px; justify-content: center; align-items: center; width: 100%; gap: 15px; }"
           ".navbar-nav li { margin: 0; }"
           "@media (max-width: 768px) { .navbar-nav { gap: 8px; } .navbar-nav a { padding: 6px 12px; font-size: 13px; } }"
           ".navbar-nav a { color: #ffffff; text-decoration: none; font-weight: 500; padding: 8px 16px; border-radius: 4px; transition: background-color 0.2s; white-space: nowrap; display: inline-block; }"
           ".navbar-nav a:hover { background-color: rgba(255, 255, 255, 0.1); }"
           ".navbar-nav a.active { background-color: #007bff; }"
           ".content-wrapper { padding: 20px; }"
           ".container { max-width: 800px; background: white; padding: 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 0 auto; overflow: hidden; }"
           ".page-header { background-color: #f8f9fa; padding: 20px 30px; border-bottom: 1px solid #dee2e6; }"
           ".page-header h1 { margin: 0; color: #212529; font-size: 1.75rem; font-weight: 700; text-transform: uppercase; }"
           ".page-content { padding: 30px; }"
           ".form-group { margin-bottom: 20px; }"
           "label { font-weight: 600; color: #555; display: block; margin-bottom: 5px; }"
           ".form-control { display: block; width: 100%; padding: 8px 12px; font-size: 14px; line-height: 1.5; color: #495057; background-color: #fff; border: 1px solid #ced4da; border-radius: 4px; }"
           ".form-control:focus { border-color: #80bdff; outline: 0; box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25); }"
           "input[type=\"file\"] { display: block; width: 100%; padding: 8px 12px; font-size: 14px; line-height: 1.5; color: #495057; background-color: #fff; border: 1px solid #ced4da; border-radius: 4px; cursor: pointer; }"
           "input[type=\"file\"]::-webkit-file-upload-button { padding: 6px 12px; margin-right: 12px; color: #fff; background-color: #007bff; border: 1px solid #007bff; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 400; }"
           "input[type=\"file\"]::-webkit-file-upload-button:hover { background-color: #0069d9; border-color: #0062cc; }"
           "input[type=\"file\"]::file-selector-button { padding: 6px 12px; margin-right: 12px; color: #fff; background-color: #007bff; border: 1px solid #007bff; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 400; }"
           "input[type=\"file\"]::file-selector-button:hover { background-color: #0069d9; border-color: #0062cc; }"
           ".btn { display: inline-block; padding: 8px 16px; font-size: 14px; font-weight: 400; text-align: center; cursor: pointer; border: 1px solid transparent; border-radius: 4px; text-decoration: none; }"
           ".btn-primary { color: #fff; background-color: #007bff; border-color: #007bff; }"
           ".btn-primary:hover { background-color: #0069d9; border-color: #0062cc; }"
           ".alert { position: relative; padding: 12px 20px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px; }"
           ".alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }"
           ".alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }"
           ".alert-warning { color: #856404; background-color: #fff3cd; border-color: #ffeaa7; }"
           ".alert-info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb; }"
           "</style>"
           "</head>"
           "<body>"
           "<nav class=\"navbar\">"
           "<ul class=\"navbar-nav\">"
           "<li><a href=\"/\">Network</a></li>"
           "<li><a href=\"/vl53l1x\">Distance</a></li>"
           "<li><a href=\"/lsm6ds3\">Gyro</a></li>"
           "<li><a href=\"/nau7802\">Scale</a></li>"
           "<li><a href=\"/gp8403\">DAC</a></li>"
           "<li><a href=\"/mcp230xx\">Outputs</a></li>"
           "<li><a href=\"/i2c\">Pull-ups</a></li>"
           "<li><a href=\"/ota\" class=\"active\">Firmware Update</a></li>"
           "</ul>"
           "</nav>"
           "<div class=\"content-wrapper\">"
           "<div class=\"container\">"
           "<div class=\"page-header\">"
           "<h1>Firmware Update</h1>"
           "</div>"
           "<div class=\"page-content\">"
           "<div style=\"margin-bottom: 20px; padding: 12px; background-color: #f8f9fa; border-left: 4px solid #007bff; border-radius: 4px;\">"
           "<p style=\"margin: 0; color: #495057; font-size: 14px; line-height: 1.6;\">"
           "<strong>Over-The-Air (OTA) Firmware Update:</strong> Upload a new firmware binary file (.bin) to update the device firmware wirelessly. "
           "Select the firmware file and click \"Start Update\" to begin the process. The device will automatically reboot after a successful update. "
           "Ensure the firmware file is compatible with your device model and that you maintain a stable network connection during the update process."
           "</p>"
           "</div>"
           "<div id=\"message\" class=\"alert\" style=\"display: none;\"></div>"
           "<form id=\"otaForm\">"
           "<div class=\"form-group\">"
           "<label for=\"firmware_file\">Firmware File (.bin):</label>"
           "<input type=\"file\" id=\"firmware_file\" class=\"form-control\" accept=\".bin\">"
           "</div>"
           "<button type=\"button\" class=\"btn btn-primary\" onclick=\"startOTA()\" style=\"margin-top:20px;\">Start Update</button>"
           "</form>"
           "</div>"
           "<footer style=\"text-align: center; padding: 20px 30px; border-top: 1px solid #dee2e6; color: #666; background-color: #f8f9fa;\">FusionCore Ethernet/IP™ Adapter</footer>"
           "</div>"
           "</div>"
           "<script>"
           "function showMessage(text, type) {"
           "  const msg = document.getElementById('message');"
           "  if (msg) {"
           "    msg.textContent = text;"
           "    msg.className = 'alert alert-' + type;"
           "    msg.style.display = 'block';"
           "  } else {"
           "    console.log('[' + type.toUpperCase() + '] ' + text);"
           "  }"
           "}"
           "function startOTA() {"
           "  const fileInput = document.getElementById('firmware_file');"
           "  if (!fileInput) {"
           "    showMessage('Error: File input not found', 'danger');"
           "    return;"
           "  }"
           "  const file = fileInput.files[0];"
           "  if (!file) {"
           "    showMessage('Please select a firmware file', 'warning');"
           "    return;"
           "  }"
           "  const formData = new FormData();"
           "  formData.append('firmware', file);"
           "  showMessage('Uploading firmware...', 'info');"
           "  fetch('/api/ota/update', {"
           "    method: 'POST',"
           "    body: formData"
           "  })"
           "    .then(function(r) {"
           "      if (!r.ok) {"
           "        throw new Error('HTTP ' + r.status);"
           "      }"
           "      return r.json();"
           "    })"
           "    .then(function(data) {"
           "      if (data.status === 'ok') {"
           "        showMessage('Firmware uploaded successfully. Device will reboot in a few seconds...', 'success');"
           "        setTimeout(function() {"
           "          window.location.href = '/';"
           "        }, 5000);"
           "      } else {"
           "        showMessage('Error: ' + (data.message || 'Unknown error'), 'danger');"
           "      }"
           "    })"
           "    .catch(function(err) {"
           "      showMessage('Error: ' + err.message, 'danger');"
           "    });"
           "}"
           "</script>"
           "</body>"
           "</html>";
}

const char *webui_get_mpu6050_status_html(void)
{
    return "";  // Removed - use API instead
}

const char *webui_get_nau7802_html(void)
{
    return "<!DOCTYPE html>"
           "<html lang=\"en\">"
           "<head>"
           "<meta charset=\"UTF-8\">"
           "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">"
           "<title>NAU7802 Scale Configuration</title>"
           "<style>"
           "* { box-sizing: border-box; }"
           "html { overflow-y: scroll; }"
           "body { padding: 0; margin: 0; background-color: #f5f5f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; scrollbar-gutter: stable; }"
           ".navbar { background-color: #212529; padding: 15px 0; margin-bottom: 20px; }"
           ".navbar-nav { display: flex; flex-direction: row; flex-wrap: wrap; list-style: none; margin: 0; padding: 0 20px; justify-content: center; align-items: center; width: 100%; gap: 15px; }"
           ".navbar-nav li { margin: 0; }"
           "@media (max-width: 768px) { .navbar-nav { gap: 8px; } .navbar-nav a { padding: 6px 12px; font-size: 13px; } }"
           ".navbar-nav a { color: #ffffff; text-decoration: none; font-weight: 500; padding: 8px 16px; border-radius: 4px; transition: background-color 0.2s; white-space: nowrap; display: inline-block; }"
           ".navbar-nav a:hover { background-color: rgba(255, 255, 255, 0.1); }"
           ".navbar-nav a.active { background-color: #007bff; }"
           ".content-wrapper { padding: 20px; }"
           ".container { max-width: 800px; background: white; padding: 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 0 auto; overflow: hidden; }"
           ".page-header { background-color: #f8f9fa; padding: 20px 30px; border-bottom: 1px solid #dee2e6; }"
           ".page-header h1 { margin: 0; color: #212529; font-size: 1.75rem; font-weight: 700; text-transform: uppercase; }"
           ".page-content { padding: 30px; }"
           ".form-group { margin-bottom: 20px; }"
           "label { font-weight: 600; color: #555; display: block; margin-bottom: 5px; }"
           ".form-control { display: block; width: 100%; padding: 8px 12px; font-size: 14px; line-height: 1.5; color: #495057; background-color: #fff; border: 1px solid #ced4da; border-radius: 4px; }"
           ".form-control:focus { border-color: #80bdff; outline: 0; box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25); }"
           ".btn { display: inline-block; padding: 8px 16px; font-size: 14px; font-weight: 400; text-align: center; cursor: pointer; border: 1px solid transparent; border-radius: 4px; text-decoration: none; }"
           ".btn-primary { color: #fff; background-color: #007bff; border-color: #007bff; }"
           ".btn-primary:hover { background-color: #0069d9; border-color: #0062cc; }"
           ".alert { position: relative; padding: 12px 20px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px; }"
           ".alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }"
           ".alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }"
           ".alert-warning { color: #856404; background-color: #fff3cd; border-color: #ffeaa7; }"
           ".alert-info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb; }"
           ".status-card { width: 100%; margin-bottom: 20px; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden; }"
           ".card-header { background-color: #f8f9fa; padding: 12px 20px; border-bottom: 1px solid #dee2e6; }"
           ".card-header h2 { margin: 0; font-size: 1.25rem; font-weight: 600; color: #212529; }"
           ".card-body { padding: 20px; }"
           "input[type=\"checkbox\"] { margin-right: 8px; }"
           "small { display: block; margin-top: 5px; color: #666; font-size: 12px; }"
           ".reading-display { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px; }"
           ".reading-item { flex: 1; min-width: 150px; padding: 15px; background-color: #f8f9fa; border-radius: 4px; }"
           ".reading-label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }"
           ".reading-value { font-size: 32px; font-weight: 700; color: #212529; font-family: monospace; }"
           ".reading-unit { font-size: 16px; color: #999; margin-left: 5px; }"
           "</style>"
           "</head>"
           "<body>"
           "<nav class=\"navbar\">"
           "<ul class=\"navbar-nav\">"
           "<li><a href=\"/\">Network</a></li>"
           "<li><a href=\"/vl53l1x\">Distance</a></li>"
           "<li><a href=\"/lsm6ds3\">Gyro</a></li>"
           "<li><a href=\"/nau7802\" class=\"active\">Scale</a></li>"
           "<li><a href=\"/gp8403\">DAC</a></li>"
           "<li><a href=\"/mcp230xx\">Outputs</a></li>"
           "<li><a href=\"/i2c\">Pull-ups</a></li>"
           "<li><a href=\"/ota\">Firmware Update</a></li>"
           "</ul>"
           "</nav>"
           "<div class=\"content-wrapper\">"
           "<div class=\"container\">"
           "<div class=\"page-header\">"
           "<h1>NAU7802 Scale Configuration</h1>"
           "</div>"
           "<div class=\"page-content\">"
           "<div id=\"nau7802_message\" class=\"alert\" style=\"display: none;\"></div>"
           "<form id=\"nau7802ConfigForm\">"
           "<div class=\"status-card\">"
           "<div class=\"card-header\">"
           "<h2>Current Weight</h2>"
           "</div>"
           "<div class=\"card-body\" style=\"padding: 30px 20px;\">"
           "<div style=\"text-align: center;\">"
           "<div style=\"font-size: 14px; color: #666; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;\">Weight</div>"
           "<div style=\"font-size: 48px; font-weight: bold; color: #212529; line-height: 1.2; margin-bottom: 15px; word-wrap: break-word; overflow-wrap: break-word;\">"
           "<span id=\"nau7802_weight_display\">--</span>"
           "<span style=\"font-size: 28px; color: #666; margin-left: 5px;\" id=\"nau7802_weight_unit\">g</span>"
           "</div>"
           "</div>"
           "</div>"
           "</div>"
           "<div class=\"status-card\">"
           "<div class=\"card-header\">"
           "<h2>Basic Configuration</h2>"
           "</div>"
           "<div class=\"card-body\">"
           "<div class=\"form-group\">"
           "<label>"
           "<input type=\"checkbox\" id=\"nau7802_enabled\" onchange=\"updateNau7802Status()\">"
           "<span>Enable NAU7802 Scale</span>"
           "</label>"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"nau7802_unit\">Weight Unit:</label>"
           "<select id=\"nau7802_unit\" class=\"form-control\" onchange=\"updateCalibrationUnitHint()\">"
           "<option value=\"0\">Grams (g)</option>"
           "<option value=\"1\">Pounds (lbs)</option>"
           "<option value=\"2\">Kilograms (kg)</option>"
           "</select>"
           "<small>Weight is stored in assembly as integer scaled by 100 (e.g., 100.24 lbs = 10024)</small>"
           "</div>"
           "</div>"
           "</div>"
           "<div class=\"status-card\">"
           "<div class=\"card-header\">"
           "<h2>Device Settings</h2>"
           "</div>"
           "<div class=\"card-body\">"
           "<div class=\"form-group\">"
           "<label for=\"nau7802_gain\">Gain:</label>"
           "<select id=\"nau7802_gain\" class=\"form-control\">"
           "<option value=\"0\">x1</option>"
           "<option value=\"1\">x2</option>"
           "<option value=\"2\">x4</option>"
           "<option value=\"3\">x8</option>"
           "<option value=\"4\">x16</option>"
           "<option value=\"5\">x32</option>"
           "<option value=\"6\">x64</option>"
           "<option value=\"7\">x128</option>"
           "</select>"
           "<small>Programmable Gain Amplifier (PGA) gain. Higher gain = higher sensitivity. <strong>Note:</strong> Changing gain automatically triggers AFE (Analog Front End) calibration, which calibrates the chip's internal hardware. This is different from weight calibration below.</small>"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"nau7802_sample_rate\">Sample Rate:</label>"
           "<select id=\"nau7802_sample_rate\" class=\"form-control\">"
           "<option value=\"0\">10 SPS</option>"
           "<option value=\"1\">20 SPS</option>"
           "<option value=\"2\">40 SPS</option>"
           "<option value=\"3\">80 SPS</option>"
           "<option value=\"7\">320 SPS</option>"
           "</select>"
           "<small>Samples per second. Lower rates = more stable, higher rates = faster updates. <strong>Note:</strong> Changing sample rate automatically triggers AFE (Analog Front End) calibration, which calibrates the chip's internal hardware. This is different from weight calibration below.</small>"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"nau7802_channel\">Channel:</label>"
           "<select id=\"nau7802_channel\" class=\"form-control\">"
           "<option value=\"0\">Channel 1</option>"
           "<option value=\"1\">Channel 2</option>"
           "</select>"
           "<small>Select active channel (NAU7802 supports dual-channel operation)</small>"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"nau7802_ldo\">LDO Voltage:</label>"
           "<select id=\"nau7802_ldo\" class=\"form-control\">"
           "<option value=\"0\">4.5V</option>"
           "<option value=\"1\">4.2V</option>"
           "<option value=\"2\">3.9V</option>"
           "<option value=\"3\">3.6V</option>"
           "<option value=\"4\">3.3V</option>"
           "<option value=\"5\">3.0V</option>"
           "<option value=\"6\">2.7V</option>"
           "<option value=\"7\">2.4V</option>"
           "</select>"
           "<small>Low-Dropout Regulator voltage. 3.3V recommended for Qwiic. Changes require reboot.</small>"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"nau7802_average\">Reading Average (Samples):</label>"
           "<input type=\"number\" id=\"nau7802_average\" class=\"form-control\" value=\"1\" min=\"1\" max=\"50\" style=\"width: 100px;\">"
           "<small>Number of samples to average for regular weight readings (1-50). Higher values = more stable but slower updates. Default: 1 (no averaging). <strong>Note:</strong> This is separate from calibration averaging below.</small>"
           "</div>"
           "</div>"
           "</div>"
           "<div class=\"status-card\">"
           "<div class=\"card-header\">"
           "<h2>Calibration</h2>"
           "</div>"
           "<div class=\"card-body\">"
           "<div class=\"form-group\">"
           "<label>Weight Calibration (Software):</label>"
           "<p style=\"font-size: 12px; color: #666; margin-bottom: 10px;\">These calibrations convert raw ADC readings to weight values. Use after changing load cells or when readings are inaccurate.</p>"
           "<div style=\"display: flex; gap: 10px; flex-wrap: wrap;\">"
           "<button type=\"button\" class=\"btn btn-primary\" onclick=\"nau7802Tare()\" id=\"nau7802_tare_btn\">Tare (Zero)</button>"
           "<button type=\"button\" class=\"btn btn-primary\" onclick=\"nau7802KnownWeight()\" id=\"nau7802_cal_btn\">Calibrate with Known Weight</button>"
           "</div>"
           "<div style=\"margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;\">"
           "<label>AFE Calibration (Hardware):</label>"
           "<p style=\"font-size: 12px; color: #666; margin-bottom: 10px;\">Calibrates the chip's Analog Front End hardware. Automatically performed when gain or sample rate changes. Use this button to manually recalibrate if needed.</p>"
           "<button type=\"button\" class=\"btn btn-primary\" onclick=\"nau7802AfeCalibrate()\" id=\"nau7802_afe_btn\">Calibrate AFE</button>"
           "</div>"
           "<div id=\"nau7802_cal_input\" style=\"display: none; margin-top: 10px;\">"
           "<input type=\"number\" id=\"nau7802_known_weight\" class=\"form-control\" placeholder=\"Known weight\" step=\"0.1\" min=\"0\" style=\"margin-bottom: 10px;\">"
           "<small id=\"nau7802_cal_unit_hint\" style=\"color: #666; display: block; margin-bottom: 10px;\">Enter weight in grams</small>"
           "<button type=\"button\" class=\"btn btn-primary\" onclick=\"nau7802PerformCalibration()\">Perform Calibration</button>"
           "<button type=\"button\" class=\"btn\" onclick=\"cancelCalibration()\" style=\"background-color: #6c757d; color: white; margin-left: 10px;\">Cancel</button>"
           "</div>"
           "</div>"
           "</div>"
           "</div>"
           "<div style=\"text-align: center; margin-top: 20px;\">"
           "<button type=\"button\" class=\"btn btn-primary\" onclick=\"saveNau7802Config()\">Save Configuration</button>"
           "</div>"
           "</form>"
           "</div>"
           "<footer style=\"text-align: center; padding: 20px 30px; border-top: 1px solid #dee2e6; color: #666; background-color: #f8f9fa;\">FusionCore Ethernet/IP™ Adapter</footer>"
           "</div>"
           "</div>"
           "<script>"
           "function showMessage(text, type) {"
           "  const msg = document.getElementById('nau7802_message');"
           "  if (msg) {"
           "    msg.textContent = text;"
           "    msg.className = 'alert alert-' + type;"
           "    msg.style.display = 'block';"
           "    setTimeout(function() { msg.style.display = 'none'; }, 5000);"
           "  } else {"
           "    console.log('[' + type.toUpperCase() + '] ' + text);"
           "  }"
           "}"
           "function loadNau7802Config() {"
           "  fetch('/api/nau7802')"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      const enabledCheckbox = document.getElementById('nau7802_enabled');"
           "      const unitSelect = document.getElementById('nau7802_unit');"
           "      const gainSelect = document.getElementById('nau7802_gain');"
           "      const sampleRateSelect = document.getElementById('nau7802_sample_rate');"
           "      const channelSelect = document.getElementById('nau7802_channel');"
           "      const ldoSelect = document.getElementById('nau7802_ldo');"
           "      const averageInput = document.getElementById('nau7802_average');"
           "      if (enabledCheckbox && data.enabled !== undefined) {"
           "        enabledCheckbox.checked = data.enabled;"
           "      }"
           "      if (unitSelect) {"
           "        if (data.unit_code !== undefined) {"
           "          unitSelect.value = data.unit_code;"
           "        } else if (data.unit !== undefined && typeof data.unit === 'number') {"
           "          unitSelect.value = data.unit;"
           "        }"
           "      }"
           "      if (gainSelect && data.gain !== undefined) {"
           "        gainSelect.value = data.gain;"
           "      }"
           "      if (sampleRateSelect && data.sample_rate !== undefined) {"
           "        sampleRateSelect.value = data.sample_rate;"
           "      }"
           "      if (channelSelect && data.channel !== undefined) {"
           "        channelSelect.value = data.channel;"
           "      }"
           "      if (ldoSelect && data.ldo_value !== undefined) {"
           "        ldoSelect.value = data.ldo_value;"
           "      }"
           "      if (averageInput && data.average !== undefined) {"
           "        averageInput.value = data.average;"
           "      }"
           "      updateCalibrationUnitHint();"
           "      updateNau7802Status();"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to load NAU7802 configuration:', err);"
           "      const statusDiv = document.getElementById('nau7802_status');"
           "      if (statusDiv) statusDiv.textContent = 'Error loading configuration';"
           "    });"
           "}"
           "function updateNau7802Status() {"
           "  fetch('/api/status')"
           "    .then(r => r.json())"
           "    .then(data => {"
           "      const nau7802 = data.nau7802 || {};"
           "      const weightDisplay = document.getElementById('nau7802_weight_display');"
           "      const weightUnit = document.getElementById('nau7802_weight_unit');"
           "      if (weightDisplay) weightDisplay.textContent = (nau7802.weight || 0).toLocaleString(undefined, {minimumFractionDigits: 3, maximumFractionDigits: 3});"
           "      if (weightUnit) weightUnit.textContent = nau7802.unit || 'g';"
           "      const statusDiv = document.getElementById('nau7802_status');"
           "      if (statusDiv) {"
           "        let status = [];"
           "        status.push('Initialized: ' + (nau7802.initialized ? 'Yes' : 'No'));"
           "        status.push('Connected: ' + (nau7802.connected ? 'Yes' : 'No'));"
           "        status.push('Available: ' + (nau7802.available ? 'Yes' : 'No'));"
           "        status.push('Raw ADC: ' + (nau7802.raw_reading || 0));"
           "        statusDiv.textContent = status.join(' | ');"
           "      }"
           "      const tareBtn = document.getElementById('nau7802_tare_btn');"
           "      const calBtn = document.getElementById('nau7802_cal_btn');"
           "      if (tareBtn) tareBtn.disabled = !nau7802.initialized || !nau7802.connected;"
           "      if (calBtn) calBtn.disabled = !nau7802.initialized || !nau7802.connected;"
           "    })"
           "    .catch(err => console.error('Failed to update NAU7802 status:', err));"
           "}"
           "function saveNau7802Config() {"
           "  const enabledCheckbox = document.getElementById('nau7802_enabled');"
           "  const unitSelect = document.getElementById('nau7802_unit');"
           "  const gainSelect = document.getElementById('nau7802_gain');"
           "  const sampleRateSelect = document.getElementById('nau7802_sample_rate');"
           "  const channelSelect = document.getElementById('nau7802_channel');"
           "  const ldoSelect = document.getElementById('nau7802_ldo');"
           "  const averageInput = document.getElementById('nau7802_average');"
           "  const data = {"
           "    enabled: enabledCheckbox ? enabledCheckbox.checked : false,"
           "    unit: unitSelect ? (unitSelect.value === '' || isNaN(parseInt(unitSelect.value)) ? 1 : parseInt(unitSelect.value)) : 1,"
           "    gain: gainSelect ? parseInt(gainSelect.value) || 7 : 7,"
           "    sample_rate: sampleRateSelect ? parseInt(sampleRateSelect.value) || 3 : 3,"
           "    channel: channelSelect ? parseInt(channelSelect.value) || 0 : 0,"
           "    ldo_value: ldoSelect ? parseInt(ldoSelect.value) || 4 : 4,"
           "    average: averageInput ? parseInt(averageInput.value) || 1 : 1"
           "  };"
           "  fetch('/api/nau7802', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify(data)"
           "  })"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      if (data.status === 'ok') {"
           "        showMessage(data.message || 'Configuration saved successfully', 'success');"
           "        updateNau7802Status();"
           "      } else {"
           "        showMessage('Failed to save configuration', 'danger');"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to save NAU7802 configuration:', err);"
           "      showMessage('Failed to save configuration', 'danger');"
           "    });"
           "}"
           "function nau7802Tare() {"
           "  if (!confirm('This will set the current reading as zero. Continue?')) return;"
           "  fetch('/api/nau7802/calibrate', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify({ action: 'tare' })"
           "  })"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      if (data.status === 'ok') {"
           "        showMessage(data.message || 'Tare completed successfully', 'success');"
           "        setTimeout(updateNau7802Status, 1000);"
           "      } else {"
           "        showMessage(data.message || 'Tare failed', 'danger');"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to perform tare:', err);"
           "      showMessage('Failed to perform tare', 'danger');"
           "    });"
           "}"
           "function updateCalibrationUnitHint() {"
           "  const unitSelect = document.getElementById('nau7802_unit');"
           "  const hint = document.getElementById('nau7802_cal_unit_hint');"
           "  if (unitSelect && hint) {"
           "    const unit = parseInt(unitSelect.value);"
           "    const unitStr = (unit === 0) ? 'grams' : (unit === 1) ? 'lbs' : 'kg';"
           "    hint.textContent = 'Enter weight in ' + unitStr;"
           "  }"
           "}"
           "function nau7802KnownWeight() {"
           "  document.getElementById('nau7802_cal_input').style.display = 'block';"
           "  updateCalibrationUnitHint();"
           "  document.getElementById('nau7802_known_weight').focus();"
           "}"
           "function cancelCalibration() {"
           "  document.getElementById('nau7802_cal_input').style.display = 'none';"
           "}"
           "function nau7802AfeCalibrate() {"
           "  if (!confirm('This will calibrate the Analog Front End (AFE) hardware. The scale must be empty and stable. Continue?')) return;"
           "  const btn = document.getElementById('nau7802_afe_btn');"
           "  if (btn) btn.disabled = true;"
           "  fetch('/api/nau7802/calibrate', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify({ action: 'afe' })"
           "  })"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      if (data.status === 'ok') {"
           "        showMessage(data.message || 'AFE calibration completed successfully', 'success');"
           "        setTimeout(updateNau7802Status, 1000);"
           "      } else {"
           "        showMessage(data.message || 'AFE calibration failed', 'danger');"
           "      }"
           "      if (btn) btn.disabled = false;"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to perform AFE calibration:', err);"
           "      showMessage('Failed to perform AFE calibration', 'danger');"
           "      if (btn) btn.disabled = false;"
           "    });"
           "}"
           "function nau7802PerformCalibration() {"
           "  const weightInput = document.getElementById('nau7802_known_weight');"
           "  const unitSelect = document.getElementById('nau7802_unit');"
           "  const knownWeight = parseFloat(weightInput.value);"
           "  if (isNaN(knownWeight) || knownWeight <= 0) {"
           "    showMessage('Please enter a valid weight greater than 0', 'danger');"
           "    return;"
           "  }"
           "  const unit = unitSelect ? parseInt(unitSelect.value) : 1;"
           "  const unitStr = (unit === 0) ? 'g' : (unit === 1) ? 'lbs' : 'kg';"
           "  if (!confirm('Place ' + knownWeight + ' ' + unitStr + ' on the scale and click OK to calibrate.')) return;"
           "  fetch('/api/nau7802/calibrate', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify({ action: 'calibrate', known_weight: knownWeight })"
           "  })"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      if (data.status === 'ok') {"
           "        showMessage(data.message || 'Calibration completed successfully', 'success');"
           "        document.getElementById('nau7802_cal_input').style.display = 'none';"
           "        weightInput.value = '';"
           "        setTimeout(updateNau7802Status, 1000);"
           "      } else {"
           "        showMessage(data.message || 'Calibration failed', 'danger');"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to perform calibration:', err);"
           "      showMessage('Failed to perform calibration', 'danger');"
           "    });"
           "}"
           "window.onload = function() {"
           "  updateNau7802Status();"
           "  setInterval(updateNau7802Status, 250);"
           "  loadNau7802Config();"
           "};"
           "</script>"
           "</body>"
           "</html>";
}

const char *webui_get_lsm6ds3_html(void)
{
    return "<!DOCTYPE html>"
           "<html lang=\"en\">"
           "<head>"
           "<meta charset=\"UTF-8\">"
           "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">"
           "<title>LSM6DS3 IMU Configuration</title>"
           "<style>"
           "* { box-sizing: border-box; }"
           "html { overflow-y: scroll; }"
           "body { padding: 0; margin: 0; background-color: #f5f5f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; scrollbar-gutter: stable; }"
           ".navbar { background-color: #212529; padding: 15px 0; margin-bottom: 20px; }"
           ".navbar-nav { display: flex; flex-direction: row; flex-wrap: wrap; list-style: none; margin: 0; padding: 0 20px; justify-content: center; align-items: center; width: 100%; gap: 15px; }"
           ".navbar-nav li { margin: 0; }"
           "@media (max-width: 768px) { .navbar-nav { gap: 8px; } .navbar-nav a { padding: 6px 12px; font-size: 13px; } }"
           ".navbar-nav a { color: #ffffff; text-decoration: none; font-weight: 500; padding: 8px 16px; border-radius: 4px; transition: background-color 0.2s; white-space: nowrap; display: inline-block; }"
           ".navbar-nav a:hover { background-color: rgba(255, 255, 255, 0.1); }"
           ".navbar-nav a.active { background-color: #007bff; }"
           ".content-wrapper { padding: 20px; }"
           ".container { max-width: 800px; background: white; padding: 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 0 auto; overflow: hidden; }"
           ".page-header { background-color: #f8f9fa; padding: 20px 30px; border-bottom: 1px solid #dee2e6; }"
           ".page-header h1 { margin: 0; color: #212529; font-size: 1.75rem; font-weight: 700; text-transform: uppercase; }"
           ".page-content { padding: 30px; }"
           ".form-group { margin-bottom: 20px; }"
           "label { font-weight: 600; color: #555; display: block; margin-bottom: 5px; }"
           ".form-control { display: block; width: 100%; padding: 8px 12px; font-size: 14px; line-height: 1.5; color: #495057; background-color: #fff; border: 1px solid #ced4da; border-radius: 4px; }"
           ".btn { display: inline-block; padding: 8px 16px; font-size: 14px; font-weight: 400; text-align: center; cursor: pointer; border: 1px solid transparent; border-radius: 4px; text-decoration: none; }"
           ".btn-primary { color: #fff; background-color: #007bff; border-color: #007bff; }"
           ".btn-primary:hover { background-color: #0069d9; border-color: #0062cc; }"
           ".alert { position: relative; padding: 12px 20px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px; }"
           ".alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }"
           ".alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }"
           ".alert-warning { color: #856404; background-color: #fff3cd; border-color: #ffeaa7; }"
           ".alert-info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb; }"
           ".status-card { width: 100%; margin-bottom: 20px; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden; }"
           ".card-header { background-color: #f8f9fa; padding: 12px 20px; border-bottom: 1px solid #dee2e6; }"
           ".card-header h2 { margin: 0; font-size: 1.25rem; font-weight: 600; color: #212529; }"
           ".card-body { padding: 20px; }"
           "input[type=\"checkbox\"] { margin-right: 8px; }"
           "small { display: block; margin-top: 5px; color: #666; font-size: 12px; }"
           ".reading-display { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }"
           ".reading-item { padding: 15px; background-color: #f8f9fa; border-radius: 4px; border: 1px solid #dee2e6; }"
           ".reading-label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }"
           ".reading-value { font-size: 24px; font-weight: 700; color: #212529; font-family: monospace; }"
           ".reading-unit { font-size: 12px; color: #999; margin-left: 5px; }"
           "footer { position: relative !important; margin-top: auto; }"
           "</style>"
           "</head>"
           "<body>"
           "<nav class=\"navbar\">"
           "<ul class=\"navbar-nav\">"
           "<li><a href=\"/\">Network</a></li>"
           "<li><a href=\"/vl53l1x\">Distance</a></li>"
           "<li><a href=\"/lsm6ds3\" class=\"active\">Gyro</a></li>"
           "<li><a href=\"/nau7802\">Scale</a></li>"
           "<li><a href=\"/gp8403\">DAC</a></li>"
           "<li><a href=\"/mcp230xx\">Outputs</a></li>"
           "<li><a href=\"/i2c\">Pull-ups</a></li>"
           "<li><a href=\"/ota\">Firmware Update</a></li>"
           "</ul>"
           "</nav>"
           "<div class=\"content-wrapper\">"
           "<div class=\"container\">"
           "<div class=\"page-header\">"
           "<h1>LSM6DS3 IMU Configuration</h1>"
           "</div>"
           "<div class=\"page-content\">"
           "<div id=\"lsm6ds3_message\" class=\"alert\" style=\"display: none;\"></div>"
           "<form id=\"lsm6ds3ConfigForm\">"
           "<div class=\"status-card\">"
           "<div class=\"card-header\">"
           "<h2>Orientation Readings</h2>"
           "</div>"
           "<div class=\"card-body\">"
           "<div class=\"reading-display\">"
           "<div class=\"reading-item\">"
           "<div class=\"reading-label\">Roll</div>"
           "<div class=\"reading-value\"><span id=\"lsm6ds3_roll\">--</span><span class=\"reading-unit\">°</span></div>"
           "</div>"
           "<div class=\"reading-item\">"
           "<div class=\"reading-label\">Pitch</div>"
           "<div class=\"reading-value\"><span id=\"lsm6ds3_pitch\">--</span><span class=\"reading-unit\">°</span></div>"
           "</div>"
           "<div class=\"reading-item\">"
           "<div class=\"reading-label\">Ground Angle</div>"
           "<div class=\"reading-value\"><span id=\"lsm6ds3_ground_angle\">--</span><span class=\"reading-unit\">°</span></div>"
           "</div>"
           "</div>"
           "<small style=\"margin-top: 15px; display: block;\">All angles are in degrees (-180.00 to +180.00). Values update every 200ms.</small>"
           "</div>"
           "</div>"
           "<div class=\"status-card\">"
           "<div class=\"card-header\">"
           "<h2>Basic Configuration</h2>"
           "</div>"
           "<div class=\"card-body\">"
           "<div class=\"form-group\">"
           "<label>"
           "<input type=\"checkbox\" id=\"lsm6ds3_enabled\" onchange=\"updateLsm6ds3Status()\">"
           "<span>Enable LSM6DS3 IMU</span>"
           "</label>"
           "<small>Enable or disable the LSM6DS3 IMU sensor. Changes require reboot to take effect.</small>"
           "</div>"
           "</div>"
           "</div>"
           "<div class=\"status-card\">"
           "<div class=\"card-header\">"
           "<h2>Calibration</h2>"
           "</div>"
           "<div class=\"card-body\">"
           "<div class=\"form-group\">"
           "<label>Sensor Calibration:</label>"
           "<p style=\"font-size: 12px; color: #666; margin-bottom: 10px;\">Calibrate gyroscope to remove sensor bias. Keep the device <strong>completely still</strong> during calibration.</p>"
           "<div style=\"display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;\">"
           "<button type=\"button\" class=\"btn btn-primary\" onclick=\"calibrateGyro()\" id=\"calibrate_gyro_btn\">Calibrate Gyroscope</button>"
           "</div>"
           "</div>"
           "<div id=\"calibration_preview_modal\" style=\"display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;\" onclick=\"if (event.target.id === 'calibration_preview_modal') closeCalibrationPreview();\">"
           "<div style=\"background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; z-index: 10001;\" onclick=\"event.stopPropagation();\">"
           "<h3 style=\"margin-top: 0;\">Calibration Preview</h3>"
           "<p>Review the calibration values before saving to flash:</p>"
           "<div id=\"calibration_preview_content\" style=\"padding: 15px; background-color: #f8f9fa; border-radius: 4px; font-family: monospace; font-size: 14px; margin: 15px 0; min-height: 60px;\">Loading calibration data...</div>"
           "<div style=\"display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;\">"
           "<button type=\"button\" class=\"btn\" onclick=\"closeCalibrationPreview()\" style=\"background-color: #6c757d; color: white;\">Cancel</button>"
           "<button type=\"button\" class=\"btn btn-primary\" onclick=\"saveCalibrationToFlash()\" id=\"save_calibration_btn\">Save to Flash</button>"
           "</div>"
           "</div>"
           "</div>"
           "<div class=\"form-group\" style=\"margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6;\">"
           "<label>NVS Calibration Values (Read-Only):</label>"
           "<p style=\"font-size: 12px; color: #666; margin-bottom: 10px;\">Calibration values stored in NVS. Gyroscope calibration and angle zero offsets are loaded at startup and applied to sensor readings. Accelerometer calibration values (if present) are not used.</p>"
           "<div id=\"nvs_calibration_status\" style=\"padding: 10px; background-color: #f8f9fa; border-radius: 4px; font-family: monospace; font-size: 12px;\">Loading...</div>"
           "</div>"
           "<div class=\"form-group\" style=\"margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6;\">"
           "<label>Angle Zero Offsets:</label>"
           "<p style=\"font-size: 12px; color: #666; margin-bottom: 10px;\">Set the current orientation as zero reference. This adjusts the reference frame for roll, pitch, and yaw angles.</p>"
           "<div style=\"display: flex; gap: 10px; flex-wrap: wrap;\">"
           "<button type=\"button\" class=\"btn btn-primary\" onclick=\"setAngleZero()\">Set Current as Zero</button>"
           "<button type=\"button\" class=\"btn\" onclick=\"clearAngleZero()\" style=\"background-color: #6c757d; color: white;\">Clear Zero Offsets</button>"
           "</div>"
           "<div id=\"angle_zero_status\" style=\"padding: 10px; background-color: #f8f9fa; border-radius: 4px; font-family: monospace; font-size: 12px; margin-top: 10px;\"></div>"
           "</div>"
           "</div>"
           "</div>"
           "</form>"
           "<div style=\"text-align: center; margin-top: 20px;\">"
           "<button type=\"button\" class=\"btn btn-primary\" onclick=\"saveLsm6ds3Config()\">Save Configuration</button>"
           "</div>"
           "</div>"
           "<footer style=\"text-align: center; padding: 20px 30px; border-top: 1px solid #dee2e6; color: #666; background-color: #f8f9fa;\">FusionCore Ethernet/IP™ Adapter</footer>"
           "</div>"
           "</div>"
           "<script>"
           "function showMessage(text, type) {"
           "  const msg = document.getElementById('lsm6ds3_message');"
           "  if (msg) {"
           "    msg.textContent = text;"
           "    msg.className = 'alert alert-' + type;"
           "    msg.style.display = 'block';"
           "    setTimeout(function() { msg.style.display = 'none'; }, 5000);"
           "  } else {"
           "    console.log('[' + type.toUpperCase() + '] ' + text);"
           "  }"
           "}"
           "function loadLsm6ds3Config() {"
           "  fetch('/api/lsm6ds3')"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      const enabledCheckbox = document.getElementById('lsm6ds3_enabled');"
           "      if (enabledCheckbox && data.enabled !== undefined) {"
           "        enabledCheckbox.checked = data.enabled;"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to load LSM6DS3 configuration:', err);"
           "      const statusDiv = document.getElementById('lsm6ds3_status');"
           "      if (statusDiv) statusDiv.textContent = 'Error loading configuration';"
           "    });"
           "}"
           "function updateLsm6ds3Status() {"
           "  fetch('/api/status')"
           "    .then(r => r.json())"
           "    .then(data => {"
           "      const lsm6ds3 = data.lsm6ds3 || {};"
           "      const statusDiv = document.getElementById('lsm6ds3_status');"
           "      if (statusDiv) {"
           "        let status = [];"
           "        status.push('Initialized: ' + (lsm6ds3.initialized ? 'Yes' : 'No'));"
           "        status.push('Enabled: ' + (lsm6ds3.enabled ? 'Yes' : 'No'));"
           "        statusDiv.textContent = status.join(' | ');"
           "      }"
           "      const rollSpan = document.getElementById('lsm6ds3_roll');"
           "      const pitchSpan = document.getElementById('lsm6ds3_pitch');"
           "      const groundAngleSpan = document.getElementById('lsm6ds3_ground_angle');"
           "      if (rollSpan) rollSpan.textContent = (lsm6ds3.roll || 0).toFixed(2);"
           "      if (pitchSpan) pitchSpan.textContent = (lsm6ds3.pitch || 0).toFixed(2);"
           "      if (groundAngleSpan) groundAngleSpan.textContent = (lsm6ds3.ground_angle || 0).toFixed(2);"
           "    })"
           "    .catch(err => console.error('Failed to update LSM6DS3 status:', err));"
           "}"
           "function saveLsm6ds3Config() {"
           "  const enabledCheckbox = document.getElementById('lsm6ds3_enabled');"
           "  const data = {"
           "    enabled: enabledCheckbox ? enabledCheckbox.checked : false"
           "  };"
           "  fetch('/api/lsm6ds3', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify(data)"
           "  })"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      if (data.status === 'ok') {"
           "        showMessage(data.message || 'Configuration saved successfully', 'success');"
           "        updateLsm6ds3Status();"
           "      } else {"
           "        showMessage('Failed to save configuration', 'danger');"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to save LSM6DS3 configuration:', err);"
           "      showMessage('Failed to save configuration', 'danger');"
           "    });"
           "}"
           "function loadCalibrationStatus() {"
           "  fetch('/api/lsm6ds3/calibrate')"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      const angleZeroDiv = document.getElementById('angle_zero_status');"
           "      if (angleZeroDiv) {"
           "        if (data.roll_zero_set || data.pitch_zero_set || data.yaw_zero_set) {"
           "          let zeroInfo = [];"
           "          if (data.roll_zero_set) zeroInfo.push('Roll: ' + data.roll_zero.toFixed(2) + '°');"
           "          if (data.pitch_zero_set) zeroInfo.push('Pitch: ' + data.pitch_zero.toFixed(2) + '°');"
           "          if (data.yaw_zero_set) zeroInfo.push('Yaw: ' + data.yaw_zero.toFixed(2) + '°');"
           "          angleZeroDiv.textContent = 'Current offsets: ' + zeroInfo.join(' | ');"
           "        } else {"
           "          angleZeroDiv.textContent = 'No angle zero offsets set';"
           "        }"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to load calibration status:', err);"
           "    });"
           "}"
           "var pendingCalibrationData = null;"
           "function calibrateGyro() {"
           "  if (!confirm('Calibrate gyroscope? Keep device completely still during calibration. This will take several seconds.')) return;"
           "  const btn = document.getElementById('calibrate_gyro_btn');"
           "  if (btn) {"
           "    btn.disabled = true;"
           "    btn.textContent = 'Calibrating...';"
           "  }"
           "  showMessage('Calibration in progress. Please keep device still...', 'info');"
           "  fetch('/api/lsm6ds3/calibrate/preview', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify({ type: 'gyro', samples: 100, sample_delay_ms: 10 })"
           "  })"
           "    .then(r => {"
           "      if (!r.ok) {"
           "        return r.text().then(text => {"
           "          throw new Error('HTTP ' + r.status + ': ' + text);"
           "        });"
           "      }"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      if (btn) {"
           "        btn.disabled = false;"
           "        btn.textContent = 'Calibrate Gyroscope';"
           "      }"
           "      console.log('Calibration response:', data);"
           "      if (data.status === 'ok' && data.offset_mdps && Array.isArray(data.offset_mdps)) {"
           "        pendingCalibrationData = data;"
           "        const previewContent = document.getElementById('calibration_preview_content');"
           "        if (previewContent) {"
           "          let html = '<strong>Gyroscope Offsets (mdps):</strong><br>';"
           "          html += 'X: ' + data.offset_mdps[0].toFixed(2) + '<br>';"
           "          html += 'Y: ' + data.offset_mdps[1].toFixed(2) + '<br>';"
           "          html += 'Z: ' + data.offset_mdps[2].toFixed(2);"
           "          html += '<br><br><strong>Samples:</strong> ' + (data.samples || 100);"
           "          previewContent.innerHTML = html;"
           "        }"
           "        const modal = document.getElementById('calibration_preview_modal');"
           "        if (modal) {"
           "          modal.style.display = 'flex';"
           "          console.log('Modal displayed');"
           "        } else {"
           "          console.error('Modal element not found');"
           "          const msg = 'Calibration completed. Offsets - X: ' + data.offset_mdps[0].toFixed(2) + ', Y: ' + data.offset_mdps[1].toFixed(2) + ', Z: ' + data.offset_mdps[2].toFixed(2) + ' mdps';"
           "          alert(msg);"
           "          showMessage('Error: Modal not found. Calibration data: ' + msg, 'danger');"
           "        }"
           "      } else {"
           "        const errorMsg = data.message || 'Gyroscope calibration preview failed' + (data.status ? ' (status: ' + data.status + ')' : '');"
           "        console.error('Calibration failed:', data);"
           "        showMessage(errorMsg, 'danger');"
           "      }"
           "    })"
           "    .catch(err => {"
           "      if (btn) {"
           "        btn.disabled = false;"
           "        btn.textContent = 'Calibrate Gyroscope';"
           "      }"
           "      console.error('Failed to calibrate gyroscope:', err);"
           "      showMessage('Failed to calibrate gyroscope: ' + err.message, 'danger');"
           "    });"
           "}"
           "function closeCalibrationPreview() {"
           "  const modal = document.getElementById('calibration_preview_modal');"
           "  if (modal) modal.style.display = 'none';"
           "  pendingCalibrationData = null;"
           "}"
           "function saveCalibrationToFlash() {"
           "  if (!pendingCalibrationData) {"
           "    showMessage('No calibration data to save', 'danger');"
           "    return;"
           "  }"
           "  const btn = document.getElementById('save_calibration_btn');"
           "  if (btn) btn.disabled = true;"
           "  fetch('/api/lsm6ds3/calibrate', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify({ type: 'gyro', samples: pendingCalibrationData.samples, sample_delay_ms: 10 })"
           "  })"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      if (btn) btn.disabled = false;"
           "      closeCalibrationPreview();"
           "      if (data.status === 'ok') {"
           "        showMessage('Calibration saved to flash successfully', 'success');"
           "        setTimeout(loadCalibrationStatus, 500);"
           "      } else {"
           "        showMessage(data.message || 'Failed to save calibration to flash', 'danger');"
           "      }"
           "    })"
           "    .catch(err => {"
           "      if (btn) btn.disabled = false;"
           "      console.error('Failed to save calibration:', err);"
           "      showMessage('Failed to save calibration to flash', 'danger');"
           "    });"
           "}"
           "function setAngleZero() {"
           "  fetch('/api/lsm6ds3')"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      if (!data.initialized || data.roll === undefined) {"
           "        showMessage('Device not initialized or no angle data available', 'danger');"
           "        return;"
           "      }"
           "      const rollStr = typeof data.roll === 'number' ? data.roll.toFixed(2) : data.roll;"
           "      const pitchStr = typeof data.pitch === 'number' ? data.pitch.toFixed(2) : data.pitch;"
           "      if (!confirm('Set current angles as zero reference? Roll: ' + rollStr + '°, Pitch: ' + pitchStr + '°, Yaw: 0°')) return;"
           "      return fetch('/api/lsm6ds3/zero', {"
           "        method: 'POST',"
           "        headers: { 'Content-Type': 'application/json' },"
           "        body: JSON.stringify({ roll: data.roll, pitch: data.pitch, yaw: 0 })"
           "      });"
           "    })"
           "    .then(r => {"
           "      if (!r) return;"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      if (data && data.status === 'ok') {"
           "        showMessage(data.message || 'Angle zero offsets set successfully', 'success');"
           "        setTimeout(loadCalibrationStatus, 500);"
           "      } else if (data && data.status === 'error') {"
           "        showMessage(data.message || 'Failed to set angle zero offsets', 'danger');"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to set angle zero:', err);"
           "      showMessage('Failed to set angle zero offsets', 'danger');"
           "    });"
           "}"
           "function clearAngleZero() {"
           "  if (!confirm('Clear angle zero offsets? This will reset the reference frame to default.')) return;"
           "  fetch('/api/lsm6ds3/zero', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify({ clear: true })"
           "  })"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      if (data.status === 'ok') {"
           "        showMessage(data.message || 'Angle zero offsets cleared successfully', 'success');"
           "        setTimeout(loadCalibrationStatus, 500);"
           "      } else {"
           "        showMessage(data.message || 'Failed to clear angle zero offsets', 'danger');"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to clear angle zero:', err);"
           "      showMessage('Failed to clear angle zero offsets', 'danger');"
           "    });"
           "}"
           "function loadNvsCalibrationStatus() {"
           "  fetch('/api/lsm6ds3/nvs-calibration')"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      const statusDiv = document.getElementById('nvs_calibration_status');"
           "      if (!statusDiv) return;"
           "      if (data.found) {"
           "        let status = [];"
           "        status.push('Gyro Calibrated: ' + (data.gyro_calibrated ? 'Yes' : 'No'));"
           "        if (data.gyro_calibrated && data.gyro_offsets_mdps) {"
           "          status.push('Gyro Offsets (mdps): X=' + data.gyro_offsets_mdps[0].toFixed(2) + ', Y=' + data.gyro_offsets_mdps[1].toFixed(2) + ', Z=' + data.gyro_offsets_mdps[2].toFixed(2));"
           "        }"
           "        statusDiv.textContent = status.join(' | ');"
           "      } else {"
           "        statusDiv.textContent = 'No calibration data found in NVS';"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to load NVS calibration:', err);"
           "      const statusDiv = document.getElementById('nvs_calibration_status');"
           "      if (statusDiv) statusDiv.textContent = 'Error loading NVS calibration';"
           "    });"
           "}"
           "window.onload = function() {"
           "  updateLsm6ds3Status();"
           "  setInterval(updateLsm6ds3Status, 250);"
           "  loadLsm6ds3Config();"
           "  loadCalibrationStatus();"
           "  loadNvsCalibrationStatus();"
           "};"
           "</script>"
           "</body>"
           "</html>";
}

const char *webui_get_mcp230xx_html(void)
{
    return "<!DOCTYPE html>"
           "<html lang=\"en\">"
           "<head>"
           "<meta charset=\"UTF-8\">"
           "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">"
           "<title>MCP230XX GPIO Configuration</title>"
           "<style>"
           "* { box-sizing: border-box; }"
           "html { overflow-y: scroll; }"
           "body { padding: 0; margin: 0; background-color: #f5f5f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; scrollbar-gutter: stable; }"
           ".navbar { background-color: #212529; padding: 15px 0; margin-bottom: 20px; }"
           ".navbar-nav { display: flex; flex-direction: row; flex-wrap: wrap; list-style: none; margin: 0; padding: 0 20px; justify-content: center; align-items: center; width: 100%; gap: 15px; }"
           ".navbar-nav li { margin: 0; }"
           "@media (max-width: 768px) { .navbar-nav { gap: 8px; } .navbar-nav a { padding: 6px 12px; font-size: 13px; } }"
           ".navbar-nav a { color: #ffffff; text-decoration: none; font-weight: 500; padding: 8px 16px; border-radius: 4px; transition: background-color 0.2s; white-space: nowrap; display: inline-block; }"
           ".navbar-nav a:hover { background-color: rgba(255, 255, 255, 0.1); }"
           ".navbar-nav a.active { background-color: #007bff; }"
           ".content-wrapper { padding: 20px; }"
           ".container { max-width: 800px; background: white; padding: 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 0 auto; overflow: hidden; }"
           ".page-header { background-color: #f8f9fa; padding: 20px 30px; border-bottom: 1px solid #dee2e6; }"
           ".page-header h1 { margin: 0; color: #212529; font-size: 1.75rem; font-weight: 700; text-transform: uppercase; }"
           ".page-content { padding: 30px; }"
           ".form-group { margin-bottom: 20px; }"
           "label { font-weight: 600; color: #555; display: block; margin-bottom: 5px; }"
           ".form-control { display: block; width: 100%; padding: 8px 12px; font-size: 14px; line-height: 1.5; color: #495057; background-color: #fff; border: 1px solid #ced4da; border-radius: 4px; }"
           ".btn { display: inline-block; padding: 8px 16px; font-size: 14px; font-weight: 400; text-align: center; cursor: pointer; border: 1px solid transparent; border-radius: 4px; text-decoration: none; }"
           ".btn-primary { color: #fff; background-color: #007bff; border-color: #007bff; }"
           ".btn-primary:hover { background-color: #0069d9; border-color: #0062cc; }"
           ".alert { position: relative; padding: 12px 20px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px; }"
           ".alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }"
           ".alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }"
           ".status-card { width: 100%; margin-bottom: 20px; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden; }"
           ".card-header { background-color: #f8f9fa; padding: 12px 20px; border-bottom: 1px solid #dee2e6; }"
           ".card-header h2 { margin: 0; font-size: 1.25rem; font-weight: 600; color: #212529; }"
           ".card-body { padding: 20px; }"
           ".gpio-table { width: 100%; border-collapse: collapse; margin-top: 15px; }"
           ".gpio-table th, .gpio-table td { padding: 10px; text-align: left; border: 1px solid #dee2e6; }"
           ".gpio-table th { background-color: #f8f9fa; font-weight: 600; }"
           ".gpio-table td { font-family: monospace; }"
           ".gpio-table input[type=\"checkbox\"] { width: 16px; height: 16px; margin: 0 2px; cursor: default; vertical-align: middle; appearance: none; -webkit-appearance: none; -moz-appearance: none; border: 2px solid #ced4da; border-radius: 3px; background-color: #fff; position: relative; }"
           ".gpio-table input[type=\"checkbox\"]:checked { background-color: #28a745 !important; border-color: #28a745 !important; }"
           ".gpio-table input[type=\"checkbox\"]:checked::after { content: '✓'; position: absolute; top: -1px; left: 1px; color: white; font-weight: bold; font-size: 12px; line-height: 16px; }"
           ".byte-input { width: 80px; padding: 5px; font-family: monospace; text-align: center; }"
           "small { display: block; margin-top: 5px; color: #666; font-size: 12px; }"
           "</style>"
           "</head>"
           "<body>"
           "<nav class=\"navbar\">"
           "<ul class=\"navbar-nav\">"
           "<li><a href=\"/\">Network</a></li>"
           "<li><a href=\"/vl53l1x\">Distance</a></li>"
           "<li><a href=\"/lsm6ds3\">Gyro</a></li>"
           "<li><a href=\"/nau7802\">Scale</a></li>"
           "<li><a href=\"/gp8403\">DAC</a></li>"
           "<li><a href=\"/mcp230xx\" class=\"active\">Outputs</a></li>"
           "<li><a href=\"/i2c\">Pull-ups</a></li>"
           "<li><a href=\"/ota\">Firmware Update</a></li>"
           "</ul>"
           "</nav>"
           "<div class=\"content-wrapper\">"
           "<div class=\"container\">"
           "<div class=\"page-header\">"
           "<h1>MCP230XX GPIO Configuration</h1>"
           "</div>"
           "<div class=\"page-content\">"
           "<div id=\"mcp230xx_message\" class=\"alert\" style=\"display: none;\"></div>"
           "<div class=\"status-card\">"
           "<div class=\"card-header\">"
           "<h2>GPIO Output States (Read-Only)</h2>"
           "</div>"
           "<div class=\"card-body\">"
           "<small>Output Assembly 150, bytes 0-15. Read-only display of current GPIO output states from configured MCP230XX devices.</small>"
           "<table class=\"gpio-table\" style=\"margin-top: 15px;\">"
           "<thead>"
           "<tr>"
           "<th>Device Address</th>"
           "<th>Byte 0 (bits 0-7)</th>"
           "<th>Byte 1 (bits 8-15)</th>"
           "</tr>"
           "</thead>"
           "<tbody id=\"mcp230xx_gpio_table\">"
           "</tbody>"
           "</table>"
           "</div>"
           "</div>"
           "<div class=\"status-card\">"
           "<div class=\"card-header\">"
           "<h2>MCP230XX Configuration</h2>"
           "</div>"
           "<div class=\"card-body\">"
           "<div class=\"form-group\">"
           "<label>"
           "<input type=\"checkbox\" id=\"mcp230xx_enabled\" onchange=\"toggleMcp230xxEnabled()\">"
           " Enable MCP230XX (requires reboot)"
           "</label>"
           "</div>"
           "<div class=\"status-card\">"
           "<div class=\"card-header\">"
           "<h2>Device Detection & Configuration</h2>"
           "</div>"
           "<div class=\"card-body\">"
           "<small>Detected column shows devices found during boot-time I2C scan. Configure device type and enable status for each address. Device detection is from boot scan only (no refresh needed).</small>"
           "<table class=\"gpio-table\" style=\"margin-top: 15px;\">"
           "<thead>"
           "<tr>"
           "<th>I2C Address</th>"
           "<th>Detected (Boot)</th>"
           "<th>Device Type</th>"
           "<th>Enabled</th>"
           "</tr>"
           "</thead>"
           "<tbody id=\"mcp230xx_devices_table\">"
           "</tbody>"
           "</table>"
           "</div>"
           "</div>"
           "</div>"
           "<footer style=\"text-align: center; padding: 20px 30px; border-top: 1px solid #dee2e6; color: #666; background-color: #f8f9fa;\">FusionCore Ethernet/IP™ Adapter</footer>"
           "</div>"
           "</div>"
           "<script>"
           "function showMessage(text, type) {"
           "  const msg = document.getElementById('mcp230xx_message');"
           "  if (msg) {"
           "    msg.textContent = text;"
           "    msg.className = 'alert alert-' + type;"
           "    msg.style.display = 'block';"
           "    setTimeout(function() { msg.style.display = 'none'; }, 5000);"
           "  } else {"
           "    console.log('[' + type.toUpperCase() + '] ' + text);"
           "  }"
           "}"
           "function formatByte(value) {"
           "  return '0x' + ('0' + (value & 0xFF).toString(16).toUpperCase()).slice(-2);"
           "}"
           "function formatBinary(value) {"
           "  let bin = (value & 0xFF).toString(2);"
           "  return ('00000000' + bin).slice(-8);"
           "}"
           "let deviceConfigCache = null;"
           "function updateGpioTable(data) {"
           "  if (!data || !data.output || !Array.isArray(data.output)) return;"
           "  const tbody = document.getElementById('mcp230xx_gpio_table');"
           "  if (!tbody) return;"
           "  tbody.innerHTML = '';"
           "  const output = data.output;"
           "  const addresses = ['0x20', '0x21', '0x22', '0x23', '0x24', '0x25', '0x26', '0x27'];"
           "  addresses.forEach((addr, idx) => {"
           "    const byteOffset = idx * 2;"
           "    const outputByte0 = (byteOffset < output.length) ? output[byteOffset] : 0;"
           "    const outputByte1 = (byteOffset + 1 < output.length) ? output[byteOffset + 1] : 0;"
           "    let deviceEnabled = false;"
           "    let deviceType = null;"
           "    if (deviceConfigCache && deviceConfigCache.devices) {"
           "      const device = deviceConfigCache.devices.find(d => d.address === addr);"
           "      if (device) {"
           "        deviceEnabled = device.enabled || false;"
           "        deviceType = device.device_type;"
           "      }"
           "    }"
           "    const isMCP23008 = (deviceType === 1);"
           "    const shouldGrayOutByte0 = !deviceEnabled;"
           "    const shouldGrayOutByte1 = !deviceEnabled || isMCP23008;"
           "    const grayStyle0 = shouldGrayOutByte0 ? ' style=\"opacity: 0.5; cursor: not-allowed;\"' : '';"
           "    const grayStyle1 = shouldGrayOutByte1 ? ' style=\"opacity: 0.5; cursor: not-allowed;\"' : '';"
           "    let byte0Checkboxes = '';"
           "    let byte1Checkboxes = '';"
           "    for (let bit = 0; bit < 8; bit++) {"
           "      const bit0Set = (outputByte0 & (1 << bit)) !== 0;"
           "      const bit1Set = (outputByte1 & (1 << bit)) !== 0;"
           "      byte0Checkboxes += '<input type=\"checkbox\" disabled' + grayStyle0 + ' ' + (bit0Set ? 'checked' : '') + '> ';"
           "      byte1Checkboxes += '<input type=\"checkbox\" disabled' + grayStyle1 + ' ' + (bit1Set ? 'checked' : '') + '> ';"
           "    }"
           "    const row = document.createElement('tr');"
           "    row.innerHTML = '<td><strong>' + addr + '</strong></td>' +"
           "      '<td style=\"font-family: monospace;\">' + byte0Checkboxes + '</td>' +"
           "      '<td style=\"font-family: monospace;\">' + byte1Checkboxes + '</td>';"
           "    tbody.appendChild(row);"
           "  });"
           "}"
           "function loadDeviceConfig() {"
           "  fetch('/api/mcp230xx/devices')"
           "    .then(r => r.json())"
           "    .then(data => {"
           "      deviceConfigCache = data;"
           "    })"
           "    .catch(err => console.error('Failed to load device config:', err));"
           "}"
           "function updateMcp230xxStatus() {"
           "  fetch('/api/status')"
           "    .then(r => r.json())"
           "    .then(statusData => {"
           "      const mcp230xx = statusData.mcp230xx || {};"
           "      const statusDiv = document.getElementById('mcp230xx_status');"
           "      if (statusDiv) {"
           "        let status = [];"
           "        if (mcp230xx.initialized !== undefined) {"
           "          status.push('Initialized: ' + (mcp230xx.initialized ? 'Yes' : 'No'));"
           "        }"
           "        statusDiv.textContent = status.join(' | ');"
           "      }"
           "      if (mcp230xx.output && Array.isArray(mcp230xx.output)) {"
           "        updateGpioTable({"
           "          initialized: mcp230xx.initialized,"
           "          output: mcp230xx.output,"
           "          feedback: mcp230xx.feedback"
           "        });"
           "      }"
           "    })"
           "    .catch(err => console.error('Failed to update MCP230XX status:', err));"
           "}"
           "function loadMcp230xxEnabled() {"
           "  fetch('/api/mcp230xx/enabled')"
           "    .then(r => r.json())"
           "    .then(data => {"
           "      const checkbox = document.getElementById('mcp230xx_enabled');"
           "      if (checkbox) checkbox.checked = data.enabled;"
           "    })"
           "    .catch(err => console.error('Failed to load MCP230XX enabled state:', err));"
           "}"
           "function toggleMcp230xxEnabled() {"
           "  const checkbox = document.getElementById('mcp230xx_enabled');"
           "  if (!checkbox) return;"
           "  const enabled = checkbox.checked;"
           "  fetch('/api/mcp230xx/enabled', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify({ enabled: enabled })"
           "  })"
           "    .then(r => r.json())"
           "    .then(data => {"
           "      if (data.status === 'ok') {"
           "        showMessage(data.message || 'MCP230XX ' + (enabled ? 'enabled' : 'disabled'), 'success');"
           "      } else {"
           "        showMessage('Failed to update MCP230XX enabled state', 'danger');"
           "        checkbox.checked = !enabled;"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to update MCP230XX enabled state:', err);"
           "      showMessage('Failed to update MCP230XX enabled state', 'danger');"
           "      checkbox.checked = !enabled;"
           "    });"
           "}"
           "function updateDevicesTable(data) {"
           "  const tbody = document.getElementById('mcp230xx_devices_table');"
           "  if (!tbody) return;"
           "  tbody.innerHTML = '';"
           "  const devices = data.devices || [];"
           "  devices.forEach(device => {"
           "    const row = document.createElement('tr');"
           "    let defaultDeviceType = 1;"
           "    if (!device.configured && device.device_type !== null && device.device_type !== undefined && (device.device_type === 0 || device.device_type === 1)) {"
           "      defaultDeviceType = device.device_type;"
           "    }"
           "    const deviceTypeSelect = device.configured ?"
           "      '<select id=\"device_type_' + device.address + '\" onchange=\"saveDeviceConfig(\\'' + device.address + '\\')\">' +"
           "      '<option value=\"0\" ' + (device.device_type === 0 ? 'selected' : '') + '>MCP23017</option>' +"
           "      '<option value=\"1\" ' + (device.device_type === 1 ? 'selected' : '') + '>MCP23008</option>' +"
           "      '</select>' :"
           "      '<select id=\"device_type_' + device.address + '\" onchange=\"saveDeviceConfig(\\'' + device.address + '\\')\">' +"
           "      '<option value=\"0\" ' + (defaultDeviceType === 0 ? 'selected' : '') + '>MCP23017</option>' +"
           "      '<option value=\"1\" ' + (defaultDeviceType === 1 ? 'selected' : '') + '>MCP23008</option>' +"
           "      '</select>';"
           "    const enabledCheckbox = '<input type=\"checkbox\" id=\"enabled_' + device.address + '\" ' +"
           "      (device.enabled ? 'checked' : '') + ' onchange=\"saveDeviceConfig(\\'' + device.address + '\\')\">';"
           "    row.innerHTML = '<td><strong>' + device.address + '</strong></td>' +"
           "      '<td>' + (device.detected ? '✓ Yes' : '✗ No') + '</td>' +"
           "      '<td>' + deviceTypeSelect + '</td>' +"
           "      '<td>' + enabledCheckbox + '</td>';"
           "    tbody.appendChild(row);"
           "  });"
           "}"
           "function loadDevices() {"
           "  fetch('/api/mcp230xx/devices')"
           "    .then(r => r.json())"
           "    .then(data => {"
           "      updateDevicesTable(data);"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to load devices:', err);"
           "      showMessage('Failed to load device information', 'danger');"
           "    });"
           "}"
           "function saveDeviceConfig(address) {"
           "  const deviceTypeSelect = document.getElementById('device_type_' + address);"
           "  const enabledCheckbox = document.getElementById('enabled_' + address);"
           "  if (!deviceTypeSelect || !enabledCheckbox) return;"
           "  const deviceType = parseInt(deviceTypeSelect.value);"
           "  const enabled = enabledCheckbox.checked;"
           "  fetch('/api/mcp230xx/config', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify({"
           "      address: address,"
           "      device_type: deviceType,"
           "      enabled: enabled"
           "    })"
           "  })"
           "    .then(r => r.json())"
           "    .then(data => {"
           "      if (data.status === 'ok') {"
           "        showMessage(data.message || 'Device configuration saved', 'success');"
           "        setTimeout(loadDevices, 500);"
           "      } else {"
           "        showMessage('Failed to save device configuration', 'danger');"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to save device configuration:', err);"
           "      showMessage('Failed to save device configuration', 'danger');"
           "    });"
           "}"
           "window.onload = function() {"
           "  updateMcp230xxStatus();"
           "  setInterval(updateMcp230xxStatus, 250);"
           "  loadMcp230xxEnabled();"
           "  loadDevices();"
           "};"
           "</script>"
           "</body>"
           "</html>";
}

const char *webui_get_i2c_html(void)
{
    return "<!DOCTYPE html>"
           "<html lang=\"en\">"
           "<head>"
           "<meta charset=\"UTF-8\">"
           "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">"
           "<title>I2C Bus Configuration</title>"
           "<style>"
           "* { box-sizing: border-box; }"
           "html { overflow-y: scroll; }"
           "body { padding: 0; margin: 0; background-color: #f5f5f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; scrollbar-gutter: stable; }"
           ".navbar { background-color: #212529; padding: 15px 0; margin-bottom: 20px; }"
           ".navbar-nav { display: flex; flex-direction: row; flex-wrap: wrap; list-style: none; margin: 0; padding: 0 20px; justify-content: center; align-items: center; width: 100%; gap: 15px; }"
           ".navbar-nav li { margin: 0; }"
           "@media (max-width: 768px) { .navbar-nav { gap: 8px; } .navbar-nav a { padding: 6px 12px; font-size: 13px; } }"
           ".navbar-nav a { color: #ffffff; text-decoration: none; font-weight: 500; padding: 8px 16px; border-radius: 4px; transition: background-color 0.2s; white-space: nowrap; display: inline-block; }"
           ".navbar-nav a:hover { background-color: rgba(255, 255, 255, 0.1); }"
           ".navbar-nav a.active { background-color: #007bff; }"
           ".content-wrapper { padding: 20px; }"
           ".container { max-width: 800px; background: white; padding: 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 0 auto; overflow: hidden; }"
           ".page-header { background-color: #f8f9fa; padding: 20px 30px; border-bottom: 1px solid #dee2e6; }"
           ".page-header h1 { margin: 0; color: #212529; font-size: 1.75rem; font-weight: 700; text-transform: uppercase; }"
           ".page-content { padding: 30px; }"
           ".form-group { margin-bottom: 20px; }"
           "label { font-weight: 600; color: #555; display: block; margin-bottom: 5px; }"
           ".form-control { display: block; width: 100%; padding: 8px 12px; font-size: 14px; line-height: 1.5; color: #495057; background-color: #fff; border: 1px solid #ced4da; border-radius: 4px; }"
           ".btn { display: inline-block; padding: 8px 16px; font-size: 14px; font-weight: 400; text-align: center; cursor: pointer; border: 1px solid transparent; border-radius: 4px; text-decoration: none; }"
           ".btn-primary { color: #fff; background-color: #007bff; border-color: #007bff; }"
           ".btn-primary:hover { background-color: #0069d9; border-color: #0062cc; }"
           ".alert { position: relative; padding: 12px 20px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px; }"
           ".alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }"
           ".alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }"
           ".alert-warning { color: #856404; background-color: #fff3cd; border-color: #ffeaa7; }"
           ".status-card { width: 100%; margin-bottom: 20px; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden; }"
           ".card-header { background-color: #f8f9fa; padding: 12px 20px; border-bottom: 1px solid #dee2e6; }"
           ".card-header h2 { margin: 0; font-size: 1.25rem; font-weight: 600; color: #212529; }"
           ".card-body { padding: 20px; }"
           "small { display: block; margin-top: 5px; color: #666; font-size: 12px; }"
           ".bus-info { background-color: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 15px; }"
           ".bus-info p { margin: 5px 0; font-family: monospace; font-size: 13px; }"
           "</style>"
           "</head>"
           "<body>"
           "<nav class=\"navbar\">"
           "<ul class=\"navbar-nav\">"
           "<li><a href=\"/\">Network</a></li>"
           "<li><a href=\"/vl53l1x\">Distance</a></li>"
           "<li><a href=\"/lsm6ds3\">Gyro</a></li>"
           "<li><a href=\"/nau7802\">Scale</a></li>"
           "<li><a href=\"/gp8403\">DAC</a></li>"
           "<li><a href=\"/mcp230xx\">Outputs</a></li>"
           "<li><a href=\"/i2c\" class=\"active\">Pull-ups</a></li>"
           "<li><a href=\"/ota\">Firmware Update</a></li>"
           "</ul>"
           "</nav>"
           "<div class=\"content-wrapper\">"
           "<div class=\"container\">"
           "<div class=\"page-header\">"
           "<h1>I2C Bus Configuration</h1>"
           "</div>"
           "<div class=\"page-content\">"
           "<div id=\"i2c_message\" class=\"alert\" style=\"display: none;\"></div>"
           "<div class=\"alert alert-warning\">"
           "<strong>Note:</strong> Changes to I2C pull-up settings require a device restart to take effect."
           "</div>"
           "<div class=\"status-card\">"
           "<div class=\"card-header\">"
           "<h2>Primary I2C Bus</h2>"
           "</div>"
           "<div class=\"card-body\">"
           "<div class=\"bus-info\">"
           "<p><strong>SDA:</strong> GPIO 7</p>"
           "<p><strong>SCL:</strong> GPIO 8</p>"
           "</div>"
           "<div class=\"form-group\">"
           "<label>"
           "<input type=\"checkbox\" id=\"i2c_primary_pullup\" onchange=\"togglePrimaryPullup()\">"
           " Enable Internal Pull-ups"
           "</label>"
           "<small>Enable ESP32 internal pull-ups (~45kΩ) for this bus. Disable if using external pull-ups (e.g., 4.7kΩ on Qwiic boards).</small>"
           "</div>"
           "</div>"
           "</div>"
           "<div class=\"status-card\">"
           "<div class=\"card-header\">"
           "<h2>Secondary I2C Bus</h2>"
           "</div>"
           "<div class=\"card-body\">"
           "<div class=\"bus-info\">"
           "<p><strong>SDA:</strong> GPIO 33</p>"
           "<p><strong>SCL:</strong> GPIO 32</p>"
           "</div>"
           "<div class=\"form-group\">"
           "<label>"
           "<input type=\"checkbox\" id=\"i2c_secondary_enabled\" onchange=\"toggleSecondaryEnabled()\">"
           " Enable Secondary I2C Bus"
           "</label>"
           "<small>Enable the secondary I2C bus on GPIO 33 (SDA) and GPIO 32 (SCL). Changes take effect immediately.</small>"
           "</div>"
           "<div class=\"form-group\">"
           "<label>"
           "<input type=\"checkbox\" id=\"i2c_secondary_pullup\" onchange=\"toggleSecondaryPullup()\">"
           " Enable Internal Pull-ups"
           "</label>"
           "<small>Enable ESP32 internal pull-ups (~45kΩ) for this bus. Disable if using external pull-ups.</small>"
           "</div>"
           "</div>"
           "</div>"
           "</div>"
           "<footer style=\"text-align: center; padding: 20px 30px; border-top: 1px solid #dee2e6; color: #666; background-color: #f8f9fa;\">FusionCore Ethernet/IP™ Adapter</footer>"
           "</div>"
           "</div>"
           "<script>"
           "function showMessage(text, type) {"
           "  const msg = document.getElementById('i2c_message');"
           "  if (msg) {"
           "    msg.textContent = text;"
           "    msg.className = 'alert alert-' + type;"
           "    msg.style.display = 'block';"
           "    setTimeout(function() { msg.style.display = 'none'; }, 5000);"
           "  } else {"
           "    console.log('[' + type.toUpperCase() + '] ' + text);"
           "  }"
           "}"
           "function loadPrimaryPullup() {"
           "  fetch('/api/i2c/pullup/primary')"
           "    .then(r => r.json())"
           "    .then(data => {"
           "      const checkbox = document.getElementById('i2c_primary_pullup');"
           "      if (checkbox) checkbox.checked = data.enabled;"
           "    })"
           "    .catch(err => console.error('Failed to load primary I2C pull-up setting:', err));"
           "}"
           "function loadSecondaryEnabled() {"
           "  fetch('/api/i2c/secondary/enabled')"
           "    .then(r => r.json())"
           "    .then(data => {"
           "      const checkbox = document.getElementById('i2c_secondary_enabled');"
           "      if (checkbox) checkbox.checked = data.enabled;"
           "    })"
           "    .catch(err => console.error('Failed to load secondary I2C bus enabled setting:', err));"
           "}"
           "function loadSecondaryPullup() {"
           "  fetch('/api/i2c/pullup/secondary')"
           "    .then(r => r.json())"
           "    .then(data => {"
           "      const checkbox = document.getElementById('i2c_secondary_pullup');"
           "      if (checkbox) checkbox.checked = data.enabled;"
           "    })"
           "    .catch(err => console.error('Failed to load secondary I2C pull-up setting:', err));"
           "}"
           "function toggleSecondaryEnabled() {"
           "  const checkbox = document.getElementById('i2c_secondary_enabled');"
           "  if (!checkbox) return;"
           "  const enabled = checkbox.checked;"
           "  fetch('/api/i2c/secondary/enabled', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify({ enabled: enabled })"
           "  })"
           "    .then(r => r.json())"
           "    .then(data => {"
           "      if (data.status === 'ok') {"
           "        showMessage(data.message || 'Secondary I2C bus setting saved and applied immediately.', 'success');"
           "      } else {"
           "        showMessage('Failed to update secondary I2C bus setting', 'danger');"
           "        checkbox.checked = !enabled;"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to update secondary I2C bus setting:', err);"
           "      showMessage('Failed to update secondary I2C bus setting', 'danger');"
           "      checkbox.checked = !enabled;"
           "    });"
           "}"
           "function togglePrimaryPullup() {"
           "  const checkbox = document.getElementById('i2c_primary_pullup');"
           "  if (!checkbox) return;"
           "  const enabled = checkbox.checked;"
           "  fetch('/api/i2c/pullup/primary', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify({ enabled: enabled })"
           "  })"
           "    .then(r => r.json())"
           "    .then(data => {"
           "      if (data.status === 'ok') {"
           "        showMessage(data.message || 'Primary I2C pull-up setting saved. Restart required.', 'success');"
           "      } else {"
           "        showMessage('Failed to update primary I2C pull-up setting', 'danger');"
           "        checkbox.checked = !enabled;"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to update primary I2C pull-up setting:', err);"
           "      showMessage('Failed to update primary I2C pull-up setting', 'danger');"
           "      checkbox.checked = !enabled;"
           "    });"
           "}"
           "function toggleSecondaryPullup() {"
           "  const checkbox = document.getElementById('i2c_secondary_pullup');"
           "  if (!checkbox) return;"
           "  const enabled = checkbox.checked;"
           "  fetch('/api/i2c/pullup/secondary', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify({ enabled: enabled })"
           "  })"
           "    .then(r => r.json())"
           "    .then(data => {"
           "      if (data.status === 'ok') {"
           "        showMessage(data.message || 'Secondary I2C pull-up setting saved. Restart required.', 'success');"
           "      } else {"
           "        showMessage('Failed to update secondary I2C pull-up setting', 'danger');"
           "        checkbox.checked = !enabled;"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to update secondary I2C pull-up setting:', err);"
           "      showMessage('Failed to update secondary I2C pull-up setting', 'danger');"
           "      checkbox.checked = !enabled;"
           "    });"
           "}"
           "window.onload = function() {"
           "  loadPrimaryPullup();"
           "  loadSecondaryEnabled();"
           "  loadSecondaryPullup();"
           "};"
           "</script>"
           "</body>"
           "</html>";
}

const char *webui_get_vl53l1x_html(void)
{
    return "<!DOCTYPE html>"
           "<html lang=\"en\">"
           "<head>"
           "<meta charset=\"UTF-8\">"
           "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">"
           "<title>VL53L1X Distance Sensor Configuration</title>"
           "<style>"
           "* { box-sizing: border-box; }"
           "html { overflow-y: scroll; }"
           "body { padding: 0; margin: 0; background-color: #f5f5f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; scrollbar-gutter: stable; }"
           ".navbar { background-color: #212529; padding: 15px 0; margin-bottom: 20px; }"
           ".navbar-nav { display: flex; flex-direction: row; flex-wrap: wrap; list-style: none; margin: 0; padding: 0 20px; justify-content: center; align-items: center; width: 100%; gap: 15px; }"
           ".navbar-nav li { margin: 0; }"
           "@media (max-width: 768px) { .navbar-nav { gap: 8px; } .navbar-nav a { padding: 6px 12px; font-size: 13px; } }"
           ".navbar-nav a { color: #ffffff; text-decoration: none; font-weight: 500; padding: 8px 16px; border-radius: 4px; transition: background-color 0.2s; white-space: nowrap; display: inline-block; }"
           ".navbar-nav a:hover { background-color: rgba(255, 255, 255, 0.1); }"
           ".navbar-nav a.active { background-color: #007bff; }"
           ".content-wrapper { padding: 20px; }"
           ".container { max-width: 800px; background: white; padding: 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 0 auto; overflow: hidden; }"
           ".page-header { background-color: #f8f9fa; padding: 20px 30px; border-bottom: 1px solid #dee2e6; }"
           ".page-header h1 { margin: 0; color: #212529; font-size: 1.75rem; font-weight: 700; text-transform: uppercase; }"
           ".page-content { padding: 30px; }"
           ".form-group { margin-bottom: 20px; }"
           "label { font-weight: 600; color: #555; display: block; margin-bottom: 5px; }"
           ".form-control { display: block; width: 100%; padding: 8px 12px; font-size: 14px; line-height: 1.5; color: #495057; background-color: #fff; border: 1px solid #ced4da; border-radius: 4px; }"
           ".btn { display: inline-block; padding: 8px 16px; font-size: 14px; font-weight: 400; text-align: center; cursor: pointer; border: 1px solid transparent; border-radius: 4px; text-decoration: none; }"
           ".btn-primary { color: #fff; background-color: #007bff; border-color: #007bff; }"
           ".btn-primary:hover { background-color: #0069d9; border-color: #0062cc; }"
           ".alert { position: relative; padding: 12px 20px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px; }"
           ".alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }"
           ".alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }"
           ".alert-warning { color: #856404; background-color: #fff3cd; border-color: #ffeaa7; }"
           ".alert-info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb; }"
           ".status-card { width: 100%; margin-bottom: 20px; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden; }"
           ".card-header { background-color: #f8f9fa; padding: 12px 20px; border-bottom: 1px solid #dee2e6; }"
           ".card-header h2 { margin: 0; font-size: 1.25rem; font-weight: 600; color: #212529; }"
           ".card-body { padding: 20px; }"
           "input[type=\"checkbox\"] { margin-right: 8px; }"
           "small { display: block; margin-top: 5px; color: #666; font-size: 12px; }"
           ".reading-display { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px; }"
           ".reading-item { flex: 1; min-width: 150px; padding: 15px; background-color: #f8f9fa; border-radius: 4px; }"
           ".reading-label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }"
           ".reading-value { font-size: 32px; font-weight: 700; color: #212529; font-family: monospace; }"
           ".reading-unit { font-size: 16px; color: #999; margin-left: 5px; }"
           "</style>"
           "</head>"
           "<body>"
           "<nav class=\"navbar\">"
           "<ul class=\"navbar-nav\">"
           "<li><a href=\"/\">Network</a></li>"
           "<li><a href=\"/vl53l1x\" class=\"active\">Distance</a></li>"
           "<li><a href=\"/lsm6ds3\">Gyro</a></li>"
           "<li><a href=\"/nau7802\">Scale</a></li>"
           "<li><a href=\"/gp8403\">DAC</a></li>"
           "<li><a href=\"/mcp230xx\">Outputs</a></li>"
           "<li><a href=\"/i2c\">Pull-ups</a></li>"
           "<li><a href=\"/ota\">Firmware Update</a></li>"
           "</ul>"
           "</nav>"
           "<div class=\"content-wrapper\">"
           "<div class=\"container\">"
           "<div class=\"page-header\">"
           "<h1>VL53L1X Distance Sensor Configuration</h1>"
           "</div>"
           "<div class=\"page-content\">"
           "<div id=\"vl53l1x_message\" class=\"alert\" style=\"display: none;\"></div>"
           "<form id=\"vl53l1xConfigForm\">"
           "<div class=\"status-card\">"
           "<div class=\"card-header\">"
           "<h2>Current Distance</h2>"
           "</div>"
           "<div class=\"card-body\" style=\"padding: 30px 20px;\">"
           "<div style=\"text-align: center;\">"
           "<div style=\"font-size: 14px; color: #666; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;\">Distance</div>"
           "<div style=\"font-size: 48px; font-weight: bold; color: #212529; line-height: 1.2; margin-bottom: 15px; word-wrap: break-word; overflow-wrap: break-word;\">"
           "<span id=\"vl53l1x_distance_display\">--</span>"
           "<span style=\"font-size: 28px; color: #666; margin-left: 5px;\">mm</span>"
           "</div>"
           "<div style=\"font-size: 16px; color: #666; margin-top: 10px;\">"
           "<span id=\"vl53l1x_distance_cm\">--</span> cm | "
           "<span id=\"vl53l1x_distance_in\">--</span> in"
           "</div>"
           "</div>"
           "</div>"
           "</div>"
           "<div class=\"status-card\">"
           "<div class=\"card-header\">"
           "<h2>Basic Configuration</h2>"
           "</div>"
           "<div class=\"card-body\">"
           "<div class=\"form-group\">"
           "<label>"
           "<input type=\"checkbox\" id=\"vl53l1x_enabled\" onchange=\"updateVl53l1xStatus()\">"
           "<span>Enable VL53L1X Distance Sensor</span>"
           "</label>"
           "<small>Enable or disable the VL53L1X distance sensor. Changes require reboot to take effect.</small>"
           "</div>"
           "</div>"
           "</div>"
           "<div class=\"status-card\">"
           "<div class=\"card-header\">"
           "<h2>Sensor Configuration</h2>"
           "</div>"
           "<div class=\"card-body\">"
           "<div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 15px;\">"
           "<div class=\"form-group\">"
           "<label for=\"vl53l1x_distance_mode\">Distance Mode:</label>"
           "<select id=\"vl53l1x_distance_mode\" class=\"form-control\">"
           "<option value=\"1\">Short (&lt;1.3m)</option>"
           "<option value=\"2\" selected>Long (&lt;4m)</option>"
           "</select>"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"vl53l1x_timing_budget\">Timing Budget (ms):</label>"
           "<select id=\"vl53l1x_timing_budget\" class=\"form-control\">"
           "<option value=\"15\">15</option>"
           "<option value=\"20\">20</option>"
           "<option value=\"33\">33</option>"
           "<option value=\"50\">50</option>"
           "<option value=\"100\" selected>100</option>"
           "<option value=\"200\">200</option>"
           "<option value=\"500\">500</option>"
           "</select>"
           "</div>"
           "<div class=\"form-group\" style=\"grid-column: 1 / -1;\">"
           "<label for=\"vl53l1x_inter_measurement\">Inter-Measurement Period (ms):</label>"
           "<input type=\"number\" id=\"vl53l1x_inter_measurement\" class=\"form-control\" value=\"100\" min=\"15\" step=\"1\">"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"vl53l1x_roi_x\">ROI X Size:</label>"
           "<input type=\"number\" id=\"vl53l1x_roi_x\" class=\"form-control\" value=\"16\" min=\"4\" max=\"16\" step=\"1\">"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"vl53l1x_roi_y\">ROI Y Size:</label>"
           "<input type=\"number\" id=\"vl53l1x_roi_y\" class=\"form-control\" value=\"16\" min=\"4\" max=\"16\" step=\"1\">"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"vl53l1x_roi_center\">ROI Center SPAD:</label>"
           "<input type=\"number\" id=\"vl53l1x_roi_center\" class=\"form-control\" value=\"199\" min=\"0\" max=\"255\" step=\"1\">"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"vl53l1x_offset\">Offset (mm):</label>"
           "<div style=\"display: flex; gap: 10px;\">"
           "<input type=\"number\" id=\"vl53l1x_offset\" class=\"form-control\" value=\"0\" step=\"1\" style=\"flex: 1;\">"
           "<button type=\"button\" class=\"btn\" onclick=\"calibrateOffset()\" style=\"background-color: #6c757d; color: white;\">Calibrate</button>"
           "</div>"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"vl53l1x_xtalk\">Xtalk (cps):</label>"
           "<div style=\"display: flex; gap: 10px;\">"
           "<input type=\"number\" id=\"vl53l1x_xtalk\" class=\"form-control\" value=\"0\" min=\"0\" step=\"1\" style=\"flex: 1;\">"
           "<button type=\"button\" class=\"btn\" onclick=\"calibrateXtalk()\" style=\"background-color: #6c757d; color: white;\">Calibrate</button>"
           "</div>"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"vl53l1x_signal_threshold\">Signal Threshold (kcps):</label>"
           "<input type=\"number\" id=\"vl53l1x_signal_threshold\" class=\"form-control\" value=\"1024\" min=\"0\" step=\"1\">"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"vl53l1x_sigma_threshold\">Sigma Threshold (mm):</label>"
           "<input type=\"number\" id=\"vl53l1x_sigma_threshold\" class=\"form-control\" value=\"15\" min=\"0\" step=\"1\">"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"vl53l1x_threshold_low\">Threshold Low (mm):</label>"
           "<input type=\"number\" id=\"vl53l1x_threshold_low\" class=\"form-control\" value=\"0\" min=\"0\" step=\"1\">"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"vl53l1x_threshold_high\">Threshold High (mm):</label>"
           "<input type=\"number\" id=\"vl53l1x_threshold_high\" class=\"form-control\" value=\"0\" min=\"0\" step=\"1\">"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"vl53l1x_threshold_window\">Threshold Window:</label>"
           "<select id=\"vl53l1x_threshold_window\" class=\"form-control\">"
           "<option value=\"0\" selected>Below</option>"
           "<option value=\"1\">Above</option>"
           "<option value=\"2\">Out</option>"
           "<option value=\"3\">In</option>"
           "</select>"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"vl53l1x_interrupt_polarity\">Interrupt Polarity:</label>"
           "<select id=\"vl53l1x_interrupt_polarity\" class=\"form-control\">"
           "<option value=\"0\">Active Low</option>"
           "<option value=\"1\" selected>Active High</option>"
           "</select>"
           "</div>"
           "<div class=\"form-group\">"
           "<label for=\"vl53l1x_i2c_address\">I2C Address:</label>"
           "<input type=\"text\" id=\"vl53l1x_i2c_address\" class=\"form-control\" value=\"0x29\" pattern=\"0x[0-9A-Fa-f]{2}\">"
           "</div>"
           "</div>"
           "<div style=\"text-align: center; margin-top: 20px;\">"
           "<button type=\"button\" class=\"btn btn-primary\" onclick=\"saveVl53l1xSensorConfig()\">Save Configuration</button>"
           "<button type=\"button\" class=\"btn\" onclick=\"loadVl53l1xSensorConfig()\" style=\"background-color: #6c757d; color: white; margin-left: 10px;\">Load Current</button>"
           "<button type=\"button\" class=\"btn\" onclick=\"resetVl53l1xSensorConfig()\" style=\"background-color: #ffc107; color: #212529; margin-left: 10px;\">Reset to Defaults</button>"
           "</div>"
           "</div>"
           "</div>"
           "</form>"
           "<div style=\"text-align: center; margin-top: 20px;\">"
           "<button type=\"button\" class=\"btn btn-primary\" onclick=\"saveVl53l1xConfig()\">Save Configuration</button>"
           "</div>"
           "</div>"
           "<footer style=\"text-align: center; padding: 20px 30px; border-top: 1px solid #dee2e6; color: #666; background-color: #f8f9fa;\">FusionCore Ethernet/IP™ Adapter</footer>"
           "</div>"
           "</div>"
           "<script>"
           "function showMessage(text, type) {"
           "  const msg = document.getElementById('vl53l1x_message');"
           "  if (msg) {"
           "    msg.textContent = text;"
           "    msg.className = 'alert alert-' + type;"
           "    msg.style.display = 'block';"
           "    setTimeout(function() { msg.style.display = 'none'; }, 5000);"
           "  } else {"
           "    console.log('[' + type.toUpperCase() + '] ' + text);"
           "  }"
           "}"
           "function loadVl53l1xConfig() {"
           "  fetch('/api/vl53l1x')"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      const enabledCheckbox = document.getElementById('vl53l1x_enabled');"
           "      if (enabledCheckbox && data.enabled !== undefined) {"
           "        enabledCheckbox.checked = data.enabled;"
           "      }"
           "      loadVl53l1xSensorConfig();"
           "      updateVl53l1xStatus();"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to load VL53L1X configuration:', err);"
           "      showMessage('Failed to load configuration', 'danger');"
           "    });"
           "}"
           "function loadVl53l1xSensorConfig() {"
           "  fetch('/api/vl53l1x/config')"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      const setValue = (id, value) => {"
           "        const el = document.getElementById(id);"
           "        if (el) el.value = value;"
           "      };"
           "      setValue('vl53l1x_distance_mode', data.distance_mode || 2);"
           "      setValue('vl53l1x_timing_budget', data.timing_budget_ms || 100);"
           "      setValue('vl53l1x_inter_measurement', data.inter_measurement_ms || 100);"
           "      setValue('vl53l1x_roi_x', data.roi_x_size || 16);"
           "      setValue('vl53l1x_roi_y', data.roi_y_size || 16);"
           "      setValue('vl53l1x_roi_center', data.roi_center_spad || 199);"
           "      setValue('vl53l1x_offset', data.offset_mm || 0);"
           "      setValue('vl53l1x_xtalk', data.xtalk_cps || 0);"
           "      setValue('vl53l1x_signal_threshold', data.signal_threshold_kcps || 1024);"
           "      setValue('vl53l1x_sigma_threshold', data.sigma_threshold_mm || 15);"
           "      setValue('vl53l1x_threshold_low', data.threshold_low_mm || 0);"
           "      setValue('vl53l1x_threshold_high', data.threshold_high_mm || 0);"
           "      setValue('vl53l1x_threshold_window', data.threshold_window || 0);"
           "      setValue('vl53l1x_interrupt_polarity', data.interrupt_polarity !== undefined ? data.interrupt_polarity : 1);"
           "      const addr = '0x' + (data.i2c_address || 0x29).toString(16).toUpperCase().padStart(2, '0');"
           "      setValue('vl53l1x_i2c_address', addr);"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to load VL53L1X sensor configuration:', err);"
           "    });"
           "}"
           "function saveVl53l1xSensorConfig() {"
           "  const getValue = (id, def) => {"
           "    const el = document.getElementById(id);"
           "    return el ? el.value : def;"
           "  };"
           "  const addrStr = getValue('vl53l1x_i2c_address', '0x29');"
           "  const addr = parseInt(addrStr, 16);"
           "  const data = {"
           "    distance_mode: parseInt(getValue('vl53l1x_distance_mode', '2')),"
           "    timing_budget_ms: parseInt(getValue('vl53l1x_timing_budget', '100')),"
           "    inter_measurement_ms: parseInt(getValue('vl53l1x_inter_measurement', '100')),"
           "    roi_x_size: parseInt(getValue('vl53l1x_roi_x', '16')),"
           "    roi_y_size: parseInt(getValue('vl53l1x_roi_y', '16')),"
           "    roi_center_spad: parseInt(getValue('vl53l1x_roi_center', '199')),"
           "    offset_mm: parseInt(getValue('vl53l1x_offset', '0')),"
           "    xtalk_cps: parseInt(getValue('vl53l1x_xtalk', '0')),"
           "    signal_threshold_kcps: parseInt(getValue('vl53l1x_signal_threshold', '1024')),"
           "    sigma_threshold_mm: parseInt(getValue('vl53l1x_sigma_threshold', '15')),"
           "    threshold_low_mm: parseInt(getValue('vl53l1x_threshold_low', '0')),"
           "    threshold_high_mm: parseInt(getValue('vl53l1x_threshold_high', '0')),"
           "    threshold_window: parseInt(getValue('vl53l1x_threshold_window', '0')),"
           "    interrupt_polarity: parseInt(getValue('vl53l1x_interrupt_polarity', '1')),"
           "    i2c_address: isNaN(addr) ? 0x29 : addr"
           "  };"
           "  fetch('/api/vl53l1x/config', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify(data)"
           "  })"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      if (data.status === 'ok') {"
           "        showMessage(data.message || 'Configuration saved successfully', 'success');"
           "        loadVl53l1xSensorConfig();"
           "      } else {"
           "        showMessage(data.message || 'Failed to save configuration', 'danger');"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to save VL53L1X sensor configuration:', err);"
           "      showMessage('Failed to save configuration: ' + err.message, 'danger');"
           "    });"
           "}"
           "function resetVl53l1xSensorConfig() {"
           "  const setValue = (id, value) => {"
           "    const el = document.getElementById(id);"
           "    if (el) el.value = value;"
           "  };"
           "  setValue('vl53l1x_distance_mode', 2);"
           "  setValue('vl53l1x_timing_budget', 100);"
           "  setValue('vl53l1x_inter_measurement', 100);"
           "  setValue('vl53l1x_roi_x', 16);"
           "  setValue('vl53l1x_roi_y', 16);"
           "  setValue('vl53l1x_roi_center', 199);"
           "  setValue('vl53l1x_offset', 0);"
           "  setValue('vl53l1x_xtalk', 0);"
           "  setValue('vl53l1x_signal_threshold', 1024);"
           "  setValue('vl53l1x_sigma_threshold', 15);"
           "  setValue('vl53l1x_threshold_low', 0);"
           "  setValue('vl53l1x_threshold_high', 0);"
           "  setValue('vl53l1x_threshold_window', 0);"
           "  setValue('vl53l1x_interrupt_polarity', 1);"
           "  setValue('vl53l1x_i2c_address', '0x29');"
           "  showMessage('Configuration reset to defaults', 'info');"
           "}"
           "function calibrateOffset() {"
           "  const targetStr = prompt('Enter target distance in mm:', '100');"
           "  if (!targetStr) return;"
           "  const target = parseInt(targetStr);"
           "  if (isNaN(target) || target <= 0) {"
           "    showMessage('Invalid target distance', 'danger');"
           "    return;"
           "  }"
           "  fetch('/api/vl53l1x/calibrate/offset', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify({ target_distance_mm: target })"
           "  })"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      if (data.status === 'ok') {"
           "        showMessage(data.message || 'Offset calibration complete', 'success');"
           "        loadVl53l1xSensorConfig();"
           "      } else {"
           "        showMessage(data.message || 'Calibration failed', 'danger');"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to calibrate offset:', err);"
           "      showMessage('Failed to calibrate offset: ' + err.message, 'danger');"
           "    });"
           "}"
           "function calibrateXtalk() {"
           "  const targetStr = prompt('Enter target distance in mm:', '100');"
           "  if (!targetStr) return;"
           "  const target = parseInt(targetStr);"
           "  if (isNaN(target) || target <= 0) {"
           "    showMessage('Invalid target distance', 'danger');"
           "    return;"
           "  }"
           "  fetch('/api/vl53l1x/calibrate/xtalk', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify({ target_distance_mm: target })"
           "  })"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      if (data.status === 'ok') {"
           "        showMessage(data.message || 'Xtalk calibration complete', 'success');"
           "        loadVl53l1xSensorConfig();"
           "      } else {"
           "        showMessage(data.message || 'Calibration failed', 'danger');"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to calibrate xtalk:', err);"
           "      showMessage('Failed to calibrate xtalk: ' + err.message, 'danger');"
           "    });"
           "}"
           "function updateVl53l1xStatus() {"
           "  fetch('/api/status')"
           "    .then(r => r.json())"
           "    .then(data => {"
           "      const vl53l1x = data.vl53l1x || {};"
           "      const distanceDisplay = document.getElementById('vl53l1x_distance_display');"
           "      const distanceCm = document.getElementById('vl53l1x_distance_cm');"
           "      const distanceIn = document.getElementById('vl53l1x_distance_in');"
           "      const distance = vl53l1x.distance_mm || 0;"
           "      if (distanceDisplay) distanceDisplay.textContent = distance.toLocaleString();"
           "      if (distanceCm) distanceCm.textContent = (distance / 10).toFixed(1) + ' cm';"
           "      if (distanceIn) distanceIn.textContent = (distance / 25.4).toFixed(2) + ' in';"
           "      const statusDiv = document.getElementById('vl53l1x_status');"
           "      if (statusDiv) {"
           "        let status = [];"
           "        status.push('Initialized: ' + (vl53l1x.initialized ? 'Yes' : 'No'));"
           "        status.push('Ambient: ' + (vl53l1x.ambient || 0));"
           "        status.push('Signal/SPAD: ' + (vl53l1x.sig_per_spad || 0));"
           "        status.push('SPADs: ' + (vl53l1x.num_spads || 0));"
           "        status.push('Status: 0x' + ((vl53l1x.status || 0).toString(16).toUpperCase().padStart(2, '0')));"
           "        statusDiv.textContent = status.join(' | ');"
           "      }"
           "    })"
           "    .catch(err => console.error('Failed to update VL53L1X status:', err));"
           "}"
           "function saveVl53l1xConfig() {"
           "  const enabledCheckbox = document.getElementById('vl53l1x_enabled');"
           "  const data = {"
           "    enabled: enabledCheckbox ? enabledCheckbox.checked : false"
           "  };"
           "  fetch('/api/vl53l1x', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify(data)"
           "  })"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      if (data.status === 'ok') {"
           "        showMessage(data.message || 'Configuration saved successfully', 'success');"
           "        updateVl53l1xStatus();"
           "      } else {"
           "        showMessage(data.message || 'Failed to save configuration', 'danger');"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to save VL53L1X configuration:', err);"
           "      showMessage('Failed to save configuration', 'danger');"
           "    });"
           "}"
           "window.onload = function() {"
           "  updateVl53l1xStatus();"
           "  setInterval(updateVl53l1xStatus, 250);"
           "  loadVl53l1xConfig();"
           "};"
           "</script>"
           "</body>"
           "</html>";
}

const char *webui_get_gp8403_html(void)
{
    return "<!DOCTYPE html>"
           "<html lang=\"en\">"
           "<head>"
           "<meta charset=\"UTF-8\">"
           "<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">"
           "<title>GP8403 DAC Configuration</title>"
           "<style>"
           "* { box-sizing: border-box; }"
           "html { overflow-y: scroll; }"
           "body { padding: 0; margin: 0; background-color: #f5f5f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; scrollbar-gutter: stable; }"
           ".navbar { background-color: #212529; padding: 15px 0; margin-bottom: 20px; }"
           ".navbar-nav { display: flex; flex-direction: row; flex-wrap: wrap; list-style: none; margin: 0; padding: 0 20px; justify-content: center; align-items: center; width: 100%; gap: 15px; }"
           ".navbar-nav li { margin: 0; }"
           "@media (max-width: 768px) { .navbar-nav { gap: 8px; } .navbar-nav a { padding: 6px 12px; font-size: 13px; } }"
           ".navbar-nav a { color: #ffffff; text-decoration: none; font-weight: 500; padding: 8px 16px; border-radius: 4px; transition: background-color 0.2s; white-space: nowrap; display: inline-block; }"
           ".navbar-nav a:hover { background-color: rgba(255, 255, 255, 0.1); }"
           ".navbar-nav a.active { background-color: #007bff; }"
           ".content-wrapper { padding: 20px; }"
           ".container { max-width: 800px; background: white; padding: 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 0 auto; overflow: hidden; }"
           ".page-header { background-color: #f8f9fa; padding: 20px 30px; border-bottom: 1px solid #dee2e6; }"
           ".page-header h1 { margin: 0; color: #212529; font-size: 1.75rem; font-weight: 700; text-transform: uppercase; }"
           ".page-content { padding: 30px; }"
           ".form-group { margin-bottom: 20px; }"
           "label { font-weight: 600; color: #555; display: block; margin-bottom: 5px; }"
           ".form-control { display: block; width: 100%; padding: 8px 12px; font-size: 14px; line-height: 1.5; color: #495057; background-color: #fff; border: 1px solid #ced4da; border-radius: 4px; }"
           ".btn { display: inline-block; padding: 8px 16px; font-size: 14px; font-weight: 400; text-align: center; cursor: pointer; border: 1px solid transparent; border-radius: 4px; text-decoration: none; }"
           ".btn-primary { color: #fff; background-color: #007bff; border-color: #007bff; }"
           ".btn-primary:hover { background-color: #0069d9; border-color: #0062cc; }"
           ".alert { position: relative; padding: 12px 20px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px; }"
           ".alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }"
           ".alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }"
           ".status-card { width: 100%; margin-bottom: 20px; border: 1px solid #dee2e6; border-radius: 4px; overflow: hidden; }"
           ".card-header { background-color: #f8f9fa; padding: 12px 20px; border-bottom: 1px solid #dee2e6; }"
           ".card-header h2 { margin: 0; font-size: 1.25rem; font-weight: 600; color: #212529; }"
           ".card-body { padding: 20px; }"
           "input[type=\"checkbox\"] { margin-right: 8px; }"
           "small { display: block; margin-top: 5px; color: #666; font-size: 12px; }"
           "table { width: 100%; border-collapse: collapse; margin-top: 15px; }"
           "table th, table td { padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; }"
           "table th { background-color: #f8f9fa; font-weight: 600; color: #212529; }"
           "table tr:hover { background-color: #f8f9fa; }"
           ".reading-display { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px; }"
           ".reading-item { flex: 1; min-width: 150px; padding: 15px; background-color: #f8f9fa; border-radius: 4px; }"
           ".reading-label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }"
           ".reading-value { font-size: 24px; font-weight: 700; color: #212529; font-family: monospace; }"
           "</style>"
           "</head>"
           "<body>"
           "<nav class=\"navbar\">"
           "<ul class=\"navbar-nav\">"
           "<li><a href=\"/\">Network</a></li>"
           "<li><a href=\"/vl53l1x\">Distance</a></li>"
           "<li><a href=\"/lsm6ds3\">Gyro</a></li>"
           "<li><a href=\"/nau7802\">Scale</a></li>"
           "<li><a href=\"/gp8403\" class=\"active\">DAC</a></li>"
           "<li><a href=\"/mcp230xx\">Outputs</a></li>"
           "<li><a href=\"/i2c\">Pull-ups</a></li>"
           "<li><a href=\"/ota\">Firmware Update</a></li>"
           "</ul>"
           "</nav>"
           "<div class=\"content-wrapper\">"
           "<div class=\"container\">"
           "<div class=\"page-header\">"
           "<h1>GP8403 DAC Configuration</h1>"
           "</div>"
           "<div class=\"page-content\">"
           "<div id=\"gp8403_message\" class=\"alert\" style=\"display: none;\"></div>"
           "<form id=\"gp8403ConfigForm\">"
           "<div class=\"status-card\">"
           "<div class=\"card-header\">"
           "<h2>Channel Values</h2>"
           "</div>"
           "<div class=\"card-body\">"
           "<p style=\"font-size: 12px; color: #666; margin-bottom: 15px;\">Current DAC channel values from Output Assembly. Values are controlled via EtherNet/IP™ Output Assembly 150 and are read-only here.</p>"
           "<table>"
           "<thead>"
           "<tr>"
           "<th>Device Address</th>"
           "<th>Channel 0 (0-4095)</th>"
           "<th>Channel 1 (0-4095)</th>"
           "</tr>"
           "</thead>"
           "<tbody id=\"gp8403_devices_table\">"
           "<tr><td colspan=\"3\" style=\"text-align: center;\">Loading...</td></tr>"
           "</tbody>"
           "</table>"
           "</div>"
           "</div>"
           "<div class=\"status-card\">"
           "<div class=\"card-header\">"
           "<h2>Basic Configuration</h2>"
           "</div>"
           "<div class=\"card-body\">"
           "<div class=\"form-group\">"
           "<label>"
           "<input type=\"checkbox\" id=\"gp8403_enabled\">"
           "<span>Enable GP8403 DAC</span>"
           "</label>"
           "<small>Enable or disable the GP8403 DAC. Changes require reboot to take effect.</small>"
           "</div>"
           "</div>"
           "</div>"
           "</form>"
           "<div style=\"text-align: center; margin-top: 20px;\">"
           "<button type=\"button\" class=\"btn btn-primary\" onclick=\"saveGp8403Config()\">Save Configuration</button>"
           "</div>"
           "</div>"
           "<footer style=\"text-align: center; padding: 20px 30px; border-top: 1px solid #dee2e6; color: #666; background-color: #f8f9fa;\">FusionCore Ethernet/IP™ Adapter</footer>"
           "</div>"
           "</div>"
           "<script>"
           "function showMessage(text, type) {"
           "  const msg = document.getElementById('gp8403_message');"
           "  if (msg) {"
           "    msg.textContent = text;"
           "    msg.className = 'alert alert-' + type;"
           "    msg.style.display = 'block';"
           "    setTimeout(function() { msg.style.display = 'none'; }, 5000);"
           "  } else {"
           "    console.log('[' + type.toUpperCase() + '] ' + text);"
           "  }"
           "}"
           "function loadGp8403Config() {"
           "  fetch('/api/gp8403')"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      const enabledCheckbox = document.getElementById('gp8403_enabled');"
           "      if (enabledCheckbox && data.enabled !== undefined) {"
           "        enabledCheckbox.checked = data.enabled;"
           "      }"
           "      updateGp8403Status();"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to load GP8403 configuration:', err);"
           "      showMessage('Failed to load configuration', 'danger');"
           "    });"
           "}"
           "function updateGp8403Status() {"
           "  fetch('/api/status')"
           "    .then(r => r.json())"
           "    .then(data => {"
           "      const gp8403 = data.gp8403 || {};"
           "      const statusDiv = document.getElementById('gp8403_status');"
           "      if (statusDiv) {"
           "        let status = [];"
           "        status.push('Initialized: ' + (gp8403.initialized ? 'Yes' : 'No'));"
           "        if (gp8403.device_count !== undefined) {"
           "          status.push('Devices Detected at Boot: ' + gp8403.device_count);"
           "        }"
           "        statusDiv.textContent = status.join(' | ');"
           "      }"
           "      if (gp8403.devices && Array.isArray(gp8403.devices)) {"
           "        updateDevicesTable(gp8403.devices);"
           "      }"
           "    })"
           "    .catch(err => console.error('Failed to update GP8403 status:', err));"
           "}"
           "function updateDevicesTable(devices) {"
           "  if (!devices || !Array.isArray(devices)) return;"
           "  const tbody = document.getElementById('gp8403_devices_table');"
           "  if (!tbody) return;"
           "  tbody.innerHTML = '';"
           "  for (let i = 0; i < 4; i++) {"
           "    const addr = 0x58 + i;"
           "    const addrStr = '0x' + addr.toString(16).toUpperCase().padStart(2, '0');"
           "    const device = devices.find(d => d && d.address === addr);"
           "    const ch0 = device && device.channel_0 !== undefined ? device.channel_0 : 0;"
           "    const ch1 = device && device.channel_1 !== undefined ? device.channel_1 : 0;"
           "    const row = document.createElement('tr');"
           "    row.innerHTML = '<td><strong>' + addrStr + '</strong></td>' +"
           "      '<td style=\"font-family: monospace;\">' + ch0 + '</td>' +"
           "      '<td style=\"font-family: monospace;\">' + ch1 + '</td>';"
           "    tbody.appendChild(row);"
           "  }"
           "}"
           "function saveGp8403Config() {"
           "  const enabledCheckbox = document.getElementById('gp8403_enabled');"
           "  if (!enabledCheckbox) {"
           "    showMessage('Checkbox not found', 'danger');"
           "    return;"
           "  }"
           "  const enabled = enabledCheckbox.checked;"
           "  const data = {"
           "    enabled: enabled"
           "  };"
           "  fetch('/api/gp8403', {"
           "    method: 'POST',"
           "    headers: { 'Content-Type': 'application/json' },"
           "    body: JSON.stringify(data)"
           "  })"
           "    .then(r => {"
           "      if (!r.ok) throw new Error('HTTP ' + r.status);"
           "      return r.json();"
           "    })"
           "    .then(data => {"
           "      if (data.status === 'ok') {"
           "        showMessage(data.message || 'Configuration saved successfully', 'success');"
           "        loadGp8403Config();"
           "      } else {"
           "        showMessage(data.message || 'Failed to save configuration', 'danger');"
           "      }"
           "    })"
           "    .catch(err => {"
           "      console.error('Failed to save GP8403 configuration:', err);"
           "      showMessage('Failed to save configuration: ' + err.message, 'danger');"
           "    });"
           "}"
           "window.onload = function() {"
           "  updateGp8403Status();"
           "  setInterval(updateGp8403Status, 250);"
           "  loadGp8403Config();"
           "};"
           "</script>"
           "</body>"
           "</html>";
}
